<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PlumaAI - Editor de Novelas con IA</title>
    <link rel="stylesheet" href="styles/main.css">
    <link rel="stylesheet" href="styles/themes.css">
    <link rel="stylesheet" href="styles/components.css">
    <link rel="stylesheet" href="styles/rich-editor.css">
    <link rel="stylesheet" href="styles/track-changes.css">

    <!-- Lucide Icons (CDN) -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Diff2html CSS para visualizaci√≥n de diffs -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css">

    <!-- jsPDF para exportar a PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- docx para exportar a DOCX -->
    <script src="https://unpkg.com/docx@7.8.2/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        /* Loading Screen Styles */
        #app-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 99999;
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }

        #app-loader.hidden {
            opacity: 0;
            visibility: hidden;
        }

        .loader-content {
            text-align: center;
            max-width: 500px;
            padding: 0 24px;
        }

        .loader-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 32px;
            position: relative;
        }

        .loader-icon::before {
            content: "‚úçÔ∏è";
            font-size: 64px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            animation: float 3s ease-in-out infinite;
        }

        .loader-circle {
            width: 80px;
            height: 80px;
            border: 3px solid rgba(74, 144, 226, 0.1);
            border-top-color: #4a90e2;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes float {
            0%, 100% { transform: translate(-50%, -50%) translateY(0px); }
            50% { transform: translate(-50%, -50%) translateY(-10px); }
        }

        .loader-title {
            font-size: 32px;
            font-weight: 700;
            color: #e0e0e0;
            margin-bottom: 16px;
            background: linear-gradient(135deg, #4a90e2 0%, #7cb3ff 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .loader-message {
            font-size: 16px;
            color: #a0a0a0;
            min-height: 24px;
            opacity: 0;
            animation: fadeInOut 3s ease-in-out infinite;
        }

        @keyframes fadeInOut {
            0%, 100% { opacity: 0; transform: translateY(10px); }
            10%, 90% { opacity: 1; transform: translateY(0); }
        }

        .loader-progress {
            width: 100%;
            max-width: 300px;
            height: 3px;
            background: rgba(74, 144, 226, 0.1);
            border-radius: 3px;
            margin: 24px auto 0;
            overflow: hidden;
        }

        .loader-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #4a90e2 0%, #7cb3ff 100%);
            border-radius: 3px;
            animation: loading 2s ease-in-out infinite;
        }

        @keyframes loading {
            0% { width: 0%; }
            50% { width: 70%; }
            100% { width: 100%; }
        }
    </style>
</head>
<body x-data="{}" x-cloak>
    <!-- Loading Screen -->
    <div id="app-loader">
        <div class="loader-content">
            <div class="loader-icon">
                <div class="loader-circle"></div>
            </div>
            <h1 class="loader-title">PlumaAI</h1>
            <p class="loader-message" id="loader-message">Cargando tu espacio creativo...</p>
            <div class="loader-progress">
                <div class="loader-progress-bar"></div>
            </div>
        </div>
    </div>
    <!-- Header will be loaded from template -->
    <div id="header-container" x-data="headerComponent"></div>

    <!-- Main Container -->
    <div class="container">
        <!-- Sidebar will be loaded from template -->
        <div id="sidebar-container" x-data="sidebarComponent"></div>

        <!-- Main Content will be loaded from template -->
        <div id="main-content-container" x-data="mainContentComponent"></div>

    <!-- Status Bar -->
    <div class="status-bar">
        <div class="status-left">
            <div class="status-item">
                <span x-text="$store.i18n.t('status.words', { count: $store.project.getStats().totalWords })"></span>
            </div>
        </div>
        <div class="status-right">
            <div class="status-item">
                <span class="ai-indicator" :class="{ 'active': $store.ai.isActive }"></span>
                <span x-text="$store.ai.isActive ? $store.i18n.t('status.ai.active') : $store.i18n.t('status.ai.inactive')"></span>
            </div>
            <div class="status-item">
                <span x-text="$store.i18n.getCurrentLocaleName()"></span>
            </div>
        </div>
    </div>

    <!-- Modal Container -->
    <div id="modal-container" x-data="modalContainerComponent()"></div>

    <!-- Sistema de traducciones modular (carga din√°mica) -->
    <!-- Los archivos antiguos es-global.js y en-global.js ya NO se usan -->
    <!-- Las traducciones ahora se cargan modularmente desde /js/i18n/locales/{lang}/{module}.js -->

    <!-- Cargar stores (formato tradicional) -->
    <script type="module" src="js/stores/i18n-global.js?v=7"></script>
    <script src="js/stores/project-global.js?v=2"></script>
    <script src="js/stores/ui-global.js?v=2"></script>
    <script src="js/stores/ai-global.js?v=2"></script>
    <script src="js/stores/version-control-global.js?v=2"></script>

    <!-- Cargar librer√≠as externas -->
    <script src="https://cdn.jsdelivr.net/npm/dexie@latest/dist/dexie.min.js"></script>
    <script src="https://unpkg.com/lunr/lunr.js"></script>

    <!-- Isomorphic-git y dependencias para control de versiones -->
    <script src="https://unpkg.com/@isomorphic-git/lightning-fs"></script>
    <script src="https://unpkg.com/isomorphic-git"></script>

    <!-- Diff libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/diff_match_patch/20121119/diff_match_patch.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js"></script>

    <!-- SortableJS for drag & drop -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

    <!-- JSZip for handling .pluma files (ZIP format) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <!-- Floating UI for intelligent popup positioning -->
    <script src="https://cdn.jsdelivr.net/npm/@floating-ui/core@1.6.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/@floating-ui/dom@1.6.3"></script>
    <script>
        // Verificar que Floating UI se carg√≥ correctamente
        window.addEventListener('DOMContentLoaded', () => {
            if (window.FloatingUIDOM) {
                console.log('‚úÖ Floating UI loaded successfully:', window.FloatingUIDOM);
            } else {
                console.error('‚ùå Floating UI failed to load!');
            }
        });
    </script>

    <!-- Cargar servicios -->
    <script src="js/services/crypto-service.js?v=2"></script>
    <script src="js/services/zip-service.js?v=2"></script>
    <script src="js/services/storage-manager.js?v=2"></script>
    <script src="js/services/version-control.js?v=2"></script>
    <script src="js/services/git-service.js?v=2"></script>
    <script src="js/services/search-service.js?v=2"></script>
    <script src="js/services/avatar-service.js?v=2"></script>
    <script src="js/services/images-gallery-service.js?v=1"></script>
    <script src="js/services/font-loader.js?v=2"></script>
    <script src="js/services/logger.js?v=2"></script>
    <script src="js/services/token-optimizer.js?v=2"></script>
    <script src="js/services/agentic-context-service.js?v=2"></script>
    <script src="js/services/ai-service.js?v=2"></script>
    <script src="js/services/ai-conversations-service.js?v=1"></script>
    <script src="js/services/track-changes-service.js?v=1"></script>
    <script src="js/services/git-integration.js?v=1"></script>

    <!-- RichEditor Library -->
    <script src="js/lib/RichEditor.js"></script>

    <!-- JsonDiffPatch for version control deltas -->
    <script src="js/lib/jsondiffpatch.min.js"></script>

    <!-- Cargar componentes -->
    <script src="js/components/header.js?v=2"></script>
    <script src="js/components/sidebar.js?v=2"></script>
    <script src="js/components/main-content.js?v=2"></script>
    <script src="js/components/relations-diagram.js?v=2"></script>
    <script src="js/components/modal-container.js?v=3"></script>
    <script src="js/components/welcome-modal.js?v=2"></script>
    <script src="js/components/settings-modal.js?v=3"></script>
    <script src="js/components/version-control.js?v=2"></script>
    <script src="js/components/publishing.js?v=2"></script>
    <script src="js/components/character-info-modal.js?v=2"></script>
    <script src="js/components/editor-alpine.js?v=2"></script>
    <script src="js/components/rich-editor-component.js?v=2"></script>
    <script src="js/components/track-changes-ui.js?v=1"></script>
    <script src="js/components/ai-assistant-view.js?v=2"></script>

    <script src="js/utils/uuid.js?v=2"></script>
    <script src="js/app.js?v=3"></script>

    <!-- Loading Messages Script -->
    <script>
        // Function to get loading messages from i18n store
        function getLoadingMessages() {
            // Wait for Alpine and i18n store to be ready
            if (window.Alpine && window.Alpine.store && window.Alpine.store('i18n')) {
                const i18n = window.Alpine.store('i18n');
                return [
                    i18n.t('loading.messages.creative'),
                    i18n.t('loading.messages.stories'),
                    i18n.t('loading.messages.pen'),
                    i18n.t('loading.messages.muses'),
                    i18n.t('loading.messages.organizing'),
                    i18n.t('loading.messages.ai'),
                    i18n.t('loading.messages.inspiration'),
                    i18n.t('loading.messages.stage'),
                    i18n.t('loading.messages.worlds'),
                    i18n.t('loading.messages.ready'),
                ];
            }
            // Fallback messages if i18n is not ready
            const browserLang = navigator.language.split('-')[0];
            return browserLang === 'es' ? [
                'Cargando tu espacio creativo...',
                'Preparando tus historias...',
                'Afinando la pluma...',
                'Invocando las musas...',
                'Organizando tus personajes...',
                'Configurando la IA...',
                'Despertando la inspiraci√≥n...',
                'Preparando el escenario...',
                'Cargando mundos imaginarios...',
                'Listo para escribir grandes historias...',
            ] : [
                'Loading your creative space...',
                'Preparing your stories...',
                'Sharpening the quill...',
                'Invoking the muses...',
                'Organizing your characters...',
                'Setting up AI...',
                'Awakening inspiration...',
                'Preparing the stage...',
                'Loading imaginary worlds...',
                'Ready to write great stories...',
            ];
        }

        let loadingMessages = getLoadingMessages();
        let messageIndex = 0;
        const messageElement = document.getElementById('loader-message');
        messageElement.textContent = loadingMessages[0];

        // Cambiar mensaje cada 2 segundos
        const messageInterval = setInterval(() => {
            // Try to update with translated messages if i18n is now available
            loadingMessages = getLoadingMessages();
            messageIndex = (messageIndex + 1) % loadingMessages.length;
            messageElement.textContent = loadingMessages[messageIndex];
        }, 2000);

        // Funci√≥n para ocultar el loader
        window.hideAppLoader = function() {
            clearInterval(messageInterval);
            const loader = document.getElementById('app-loader');
            loader.classList.add('hidden');
            setTimeout(() => {
                loader.remove();
            }, 500);
        };
    </script>


    <!-- Alpine.js 3.x - Cargar al final -->
    <!-- Alpine Collapse Plugin - DEBE cargarse ANTES de Alpine.js -->
    <!-- NOTA: Los scripts de Alpine.js se cargan manualmente despu√©s de que las traducciones est√©n listas -->
    <script id="alpine-collapse-script" data-src="https://cdn.jsdelivr.net/npm/@alpinejs/collapse@3.x.x/dist/cdn.min.js"></script>
    <script id="alpine-script" data-src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script>
        // Inicializar traducciones y luego cargar Alpine.js
        (async function() {
            console.log('üöÄ Iniciando carga de PlumaAI...');

            const loadAlpine = () => {
                console.log('üì¶ Cargando Alpine.js...');
                // Cargar Alpine Collapse primero
                const collapseScript = document.createElement('script');
                collapseScript.src = document.getElementById('alpine-collapse-script').getAttribute('data-src');
                collapseScript.onload = () => {
                    // Luego cargar Alpine.js
                    const alpineScript = document.createElement('script');
                    alpineScript.src = document.getElementById('alpine-script').getAttribute('data-src');
                    document.body.appendChild(alpineScript);
                };
                document.body.appendChild(collapseScript);
            };

            // Esperar a que window.i18nStore est√© disponible
            const waitForI18nStore = () => {
                return new Promise((resolve) => {
                    if (window.i18nStore) {
                        resolve();
                    } else {
                        const checkInterval = setInterval(() => {
                            if (window.i18nStore) {
                                clearInterval(checkInterval);
                                resolve();
                            }
                        }, 50);
                    }
                });
            };

            try {
                // Esperar a que el store i18n est√© disponible
                await waitForI18nStore();
                console.log('üìö Store i18n disponible, inicializando traducciones...');

                // Inicializar traducciones
                await window.i18nStore.init();
                console.log('‚úÖ Traducciones listas, cargando Alpine.js...');

                // Cargar Alpine.js
                loadAlpine();
            } catch (error) {
                console.error('‚ùå Error inicializando traducciones:', error);
                console.warn('‚ö†Ô∏è Cargando Alpine.js sin traducciones...');
                loadAlpine();
            }
        })();
    </script>

    <!-- Initialize Lucide Icons -->
    <script>
        // Initialize Lucide icons after Alpine renders
        document.addEventListener('alpine:initialized', () => {
            lucide.createIcons();
            console.log('‚úÖ Lucide icons initialized');

            // Ocultar el loader despu√©s de que todo est√© cargado
            setTimeout(() => {
                window.hideAppLoader();
                console.log('‚úÖ App loader hidden');
            }, 800); // Peque√±o delay para asegurar que todo est√° renderizado
        });

        // Los iconos se reinicializan autom√°ticamente cuando se necesitan:
        // - Al abrir modales (modal-container.js)
        // - Al cambiar vistas (main-content.html)
        // - Al enviar formularios (cada template de modal)
        // No necesitamos polling constante
    </script>
</body>
</html>
