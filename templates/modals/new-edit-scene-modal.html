<!-- New/Edit Scene Modal -->
<template x-if="$store.ui.modals.newScene || $store.ui.modals.editScene">
<div class="legacy-modal active">
    <div class="legacy-modal-content">
        <div class="legacy-modal-header">
            <h2 x-text="$store.ui.modals.editScene ? $store.i18n.t('scenes.edit') : $store.i18n.t('scenes.new')">Escena</h2>
            <button class="btn-close" @click="$store.ui.closeModal()">
                <i data-lucide="x" width="20" height="20"></i>
            </button>
        </div>
        <div class="modal-body" x-data="{
            imagePreview: $store.ui.modalData?.image || '',
            imageType: $store.ui.modalData?.imageType || 'upload',
            generatingImage: false,
            aiPrompt: '',
            selectedAIProvider: null,

            get availableAIProviders() {
                if (!window.aiService) return [];
                return window.aiService.getAvailableImageProviders();
            },

            handleImageUpload(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        this.imagePreview = e.target.result;
                        this.imageType = 'upload';
                    };
                    reader.readAsDataURL(file);
                }
            },

            handleImageUrl(url) {
                this.imagePreview = url;
                this.imageType = 'url';
            },

            removeImage() {
                this.imagePreview = '';
                this.imageType = 'upload';
            },

            async generateImageWithAI(formElement) {
                if (!window.aiService) {
                    $store.ui.error($store.i18n.t('common.error'), $store.i18n.t('errors.aiServiceNotAvailable'));
                    return;
                }

                const providers = this.availableAIProviders;
                if (providers.length === 0) {
                    $store.ui.error($store.i18n.t('common.error'), $store.i18n.t('errors.noAIProvidersConfigured'));
                    return;
                }

                this.generatingImage = true;

                try {
                    const sceneData = {
                        name: formElement.querySelector('[name=title]')?.value || $store.i18n.t('scenes.defaultName'),
                        description: this.aiPrompt || ''
                    };

                    const prompt = this.aiPrompt || window.aiService.buildImagePrompt('scene', sceneData);
                    const result = await window.aiService.generateImage(prompt, this.selectedAIProvider);

                    this.imagePreview = result.url;
                    this.imageType = 'ai';

                    $store.ui.success($store.i18n.t('scenes.imageGenerated'), `${$store.i18n.t('common.generatedWith')} ${result.provider}`);
                } catch (error) {
                    console.error('Error generando imagen:', error);
                    $store.ui.error($store.i18n.t('errors.imageGenerationFailed'), error.message);
                } finally {
                    this.generatingImage = false;
                }
            },

            submitForm(form) {
                // Obtener contenido de los RichEditors
                let descriptionEditor = form.querySelector('[data-field=description]')?.__x?.$data;
                let notesEditor = form.querySelector('[data-field=notes]')?.__x?.$data;

                // Obtener el contenido del editor, preservando el valor existente si el editor no devuelve nada válido
                let description = descriptionEditor?.getContent() ?? $store.ui.modalData?.description ?? '';
                let notes = notesEditor?.getContent() ?? $store.ui.modalData?.notes ?? '';

                let formData = {
                    title: form.querySelector('[name=title]').value,
                    description: description,
                    notes: notes,
                    image: this.imagePreview,
                    imageType: this.imageType
                };
                if ($store.ui.modalData?.id) {
                    $store.project.updateScene($store.ui.modalData.id, formData);
                    $store.ui.success($store.i18n.t('notifications.success.sceneUpdated'), '');
                } else {
                    $store.project.addScene(formData);
                    $store.ui.success($store.i18n.t('notifications.success.sceneCreated'), '');
                }
                $store.ui.closeModal();
                form.reset();
                lucide.createIcons();
            }
        }">
            <form @submit.prevent="submitForm($el)">
                <!-- Image Section -->
                <div class="form-group">
                    <label x-text="$store.i18n.t('scenes.form.image')"></label>

                    <!-- Image Preview -->
                    <div class="image-preview-container" style="margin-bottom: 12px;">
                        <div x-show="imagePreview" class="image-preview" style="position: relative; width: 100%; height: 150px; border-radius: 8px; overflow: hidden; background: var(--bg-tertiary);">
                            <img :src="imagePreview" style="width: 100%; height: 100%; object-fit: cover;">
                            <button type="button" @click="removeImage()" class="btn-icon" style="position: absolute; top: 8px; right: 8px; background: rgba(0,0,0,0.6);">
                                <i data-lucide="x" width="16" height="16"></i>
                            </button>
                        </div>
                        <div x-show="!imagePreview" class="empty-image-preview" style="width: 100%; height: 150px; border: 2px dashed var(--border-color); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: var(--text-secondary);">
                            <div style="text-align: center;">
                                <i data-lucide="image" width="32" height="32" style="opacity: 0.5;"></i>
                                <p style="font-size: 12px;" x-text="$store.i18n.t('common.noImage')"></p>
                            </div>
                        </div>
                    </div>

                    <!-- Image Upload/URL/AI Tabs -->
                    <div class="tabs" style="display: flex; gap: 6px; margin-bottom: 10px; flex-wrap: wrap;">
                        <button type="button" class="btn-secondary" :class="{ 'btn-primary': imageType === 'upload' }" @click="imageType = 'upload'" style="padding: 6px 12px; font-size: 13px;">
                            <i data-lucide="upload" width="14" height="14"></i>
                            <span x-text="$store.i18n.t('common.upload')"></span>
                        </button>
                        <button type="button" class="btn-secondary" :class="{ 'btn-primary': imageType === 'url' }" @click="imageType = 'url'" style="padding: 6px 12px; font-size: 13px;">
                            <i data-lucide="link" width="14" height="14"></i>
                            <span x-text="$store.i18n.t('common.url')"></span>
                        </button>
                        <button type="button" class="btn-secondary" :class="{ 'btn-primary': imageType === 'ai' }" @click="imageType = 'ai'" style="padding: 6px 12px; font-size: 13px;">
                            <i data-lucide="sparkles" width="14" height="14"></i>
                            <span x-text="$store.i18n.t('common.generateWithAI')"></span>
                        </button>
                    </div>

                    <!-- Upload Input -->
                    <div x-show="imageType === 'upload'">
                        <input type="file" accept="image/*" @change="handleImageUpload($event)" class="file-input">
                    </div>

                    <!-- URL Input -->
                    <div x-show="imageType === 'url'">
                        <input type="url" :value="imagePreview" @input="handleImageUrl($event.target.value)" placeholder="https://..." class="input">
                    </div>

                    <!-- AI Generation Panel -->
                    <div x-show="imageType === 'ai'" style="padding: 12px; background: var(--bg-tertiary); border-radius: 8px;">
                        <div style="margin-bottom: 10px;">
                            <label style="display: block; margin-bottom: 4px; color: var(--text-secondary); font-size: 12px;" x-text="$store.i18n.t('common.promptOptional')"></label>
                            <textarea
                                x-model="aiPrompt"
                                :placeholder="$store.i18n.t('common.describeImage')"
                                style="width: 100%; min-height: 50px; padding: 6px; background: var(--bg-primary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary); resize: vertical; font-family: inherit; font-size: 13px;">
                            </textarea>
                        </div>
                        <button
                            type="button"
                            class="btn-primary"
                            @click="generateImageWithAI($el.closest('form'))"
                            :disabled="generatingImage || availableAIProviders.length === 0"
                            style="width: 100%; padding: 8px; font-size: 13px;">
                            <template x-if="!generatingImage">
                                <span><i data-lucide="wand-2" width="14" height="14" style="vertical-align: middle;"></i> <span x-text="$store.i18n.t('common.generate')"></span></span>
                            </template>
                            <template x-if="generatingImage">
                                <span><div class="spinner" style="width: 14px; height: 14px; display: inline-block;"></div> <span x-text="$store.i18n.t('common.generating')"></span></span>
                            </template>
                        </button>
                        <template x-if="availableAIProviders.length === 0">
                            <div style="margin-top: 8px; padding: 8px; background: rgba(255,160,0,0.1); border-radius: 4px; font-size: 11px; color: var(--text-secondary);">
                                <i data-lucide="alert-circle" width="12" height="12"></i> <span x-text="$store.i18n.t('errors.configureAPIKey')"></span>
                            </div>
                        </template>
                    </div>
                </div>

                <div class="form-divider"></div>

                <div class="form-group">
                    <label x-text="$store.i18n.t('scenes.form.title')">Título</label>
                    <input type="text" name="title" required :placeholder="$store.i18n.t('scenes.form.titlePlaceholder')" :value="$store.ui.modalData?.title || ''">
                </div>
                <!-- Description Rich Editor -->
                <div class="form-group" x-data="richEditorComponent({
                    placeholder: $store.i18n.t('scenes.form.descriptionPlaceholder'),
                    initialContent: $store.ui.modalData?.description || '',
                    enableMentions: true,
                    enableCommands: false
                })" x-init="() => { $el.dataset.field = 'description'; }">
                    <label x-text="$store.i18n.t('scenes.form.description')">Descripción</label>
                    <div x-ref="editorContainer" class="rich-editor-wrapper"></div>
                </div>

                <!-- Notes Rich Editor -->
                <div class="form-group" x-data="richEditorComponent({
                    placeholder: $store.i18n.t('scenes.form.notes'),
                    initialContent: $store.ui.modalData?.notes || '',
                    enableMentions: true,
                    enableCommands: false
                })" x-init="() => { $el.dataset.field = 'notes'; }">
                    <label x-text="$store.i18n.t('scenes.form.notes')">Notas</label>
                    <div x-ref="editorContainer" class="rich-editor-wrapper"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" @click="$store.ui.closeModal()" x-text="$store.i18n.t('common.cancel')">Cancelar</button>
                    <button type="submit" class="btn-primary" x-text="$store.ui.modalData?.id ? $store.i18n.t('common.save') : $store.i18n.t('common.create')">Guardar</button>
                </div>
            </form>
        </div>
    </div>
</div>
</template>