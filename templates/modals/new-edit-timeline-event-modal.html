<!-- New/Edit Timeline Event Modal -->
<template x-if="$store.ui.modals.newTimelineEvent || $store.ui.modals.editTimelineEvent">
<div class="legacy-modal active">
    <div class="legacy-modal-content" style="max-width: 800px;">
        <div class="legacy-modal-header">
            <h2 x-text="$store.ui.modals.editTimelineEvent ? $store.i18n.t('timeline.edit') : $store.i18n.t('timeline.new')">Evento</h2>
            <button class="btn-close" @click="$store.ui.closeModal()">
                <i data-lucide="x" width="20" height="20"></i>
            </button>
        </div>
        <div class="modal-body" x-data="{
            dateMode: $store.ui.modalData?.dateMode || 'absolute',
            importance: $store.ui.modalData?.importance || 'medium',
            selectedParticipants: $store.ui.modalData?.participants || [],
            selectedLocation: $store.ui.modalData?.location || '',
            selectedScenes: $store.ui.modalData?.sceneIds || [],
            selectedChapters: $store.ui.modalData?.chapterIds || [],
            tags: $store.ui.modalData?.tags || [],
            tagInput: '',

            addTag() {
                if (this.tagInput.trim() && !this.tags.includes(this.tagInput.trim())) {
                    this.tags.push(this.tagInput.trim());
                    this.tagInput = '';
                }
            },

            removeTag(tag) {
                this.tags = this.tags.filter(t => t !== tag);
            },

            toggleParticipant(charId) {
                if (this.selectedParticipants.includes(charId)) {
                    this.selectedParticipants = this.selectedParticipants.filter(id => id !== charId);
                } else {
                    this.selectedParticipants.push(charId);
                }
            },

            toggleScene(sceneId) {
                if (this.selectedScenes.includes(sceneId)) {
                    this.selectedScenes = this.selectedScenes.filter(id => id !== sceneId);
                } else {
                    this.selectedScenes.push(sceneId);
                }
            },

            toggleChapter(chapterId) {
                if (this.selectedChapters.includes(chapterId)) {
                    this.selectedChapters = this.selectedChapters.filter(id => id !== chapterId);
                } else {
                    this.selectedChapters.push(chapterId);
                }
            },

            submitForm(form) {
                // Obtener contenido de los RichEditors
                let descriptionEditor = form.querySelector('[data-field=description]')?.__x?.$data;
                let notesEditor = form.querySelector('[data-field=notes]')?.__x?.$data;

                // Obtener el contenido del editor, preservando el valor existente si el editor no devuelve nada válido
                let description = descriptionEditor?.getContent() ?? $store.ui.modalData?.description ?? '';
                let notes = notesEditor?.getContent() ?? $store.ui.modalData?.notes ?? '';

                let formData = {
                    event: form.querySelector('[name=event]').value,
                    description: description,
                    dateMode: this.dateMode,
                    importance: this.importance,
                    participants: this.selectedParticipants,
                    location: this.selectedLocation,
                    sceneIds: this.selectedScenes,
                    chapterIds: this.selectedChapters,
                    tags: this.tags,
                    notes: notes
                };

                // Agregar campos específicos según el modo de fecha
                if (this.dateMode === 'absolute') {
                    formData.date = form.querySelector('[name=date]')?.value || '';
                } else if (this.dateMode === 'era') {
                    formData.era = form.querySelector('[name=era]')?.value || '';
                }

                if ($store.ui.modalData?.id) {
                    $store.project.updateTimelineEvent($store.ui.modalData.id, formData);
                    $store.ui.success($store.i18n.t('notifications.success.eventUpdated'), '');
                } else {
                    $store.project.addTimelineEvent(formData);
                    $store.ui.success($store.i18n.t('notifications.success.eventCreated'), '');
                }
                $store.ui.closeModal();
                form.reset();
                lucide.createIcons();
            }
        }">
            <form @submit.prevent="submitForm($el)">
                <!-- Event Name -->
                <div class="form-group">
                    <label x-text="$store.i18n.t('timeline.form.event')">Evento</label>
                    <input type="text" name="event" required :placeholder="$store.i18n.t('timeline.form.eventPlaceholder')" :value="$store.ui.modalData?.event || ''">
                </div>

                <!-- Date Mode Selector -->
                <div class="form-group">
                    <label x-text="$store.i18n.t('timeline.form.dateMode') || 'Modo de Fecha'">Modo de Fecha</label>
                    <div style="display: flex; gap: 8px;">
                        <button type="button" class="btn-secondary" :class="{ 'btn-primary': dateMode === 'absolute' }" @click="dateMode = 'absolute'">
                            <i data-lucide="calendar" width="16" height="16"></i>
                            <span x-text="$store.i18n.t('timeline.dateMode.absolute') || 'Absoluto'">Absoluto</span>
                        </button>
                        <button type="button" class="btn-secondary" :class="{ 'btn-primary': dateMode === 'relative' }" @click="dateMode = 'relative'">
                            <i data-lucide="git-compare" width="16" height="16"></i>
                            <span x-text="$store.i18n.t('timeline.dateMode.relative') || 'Relativo'">Relativo</span>
                        </button>
                        <button type="button" class="btn-secondary" :class="{ 'btn-primary': dateMode === 'era' }" @click="dateMode = 'era'">
                            <i data-lucide="layers" width="16" height="16"></i>
                            <span x-text="$store.i18n.t('timeline.dateMode.era') || 'Era'">Era</span>
                        </button>
                    </div>
                </div>

                <!-- Date Input (Absolute Mode) -->
                <div class="form-group" x-show="dateMode === 'absolute'">
                    <label x-text="$store.i18n.t('timeline.form.date')">Fecha</label>
                    <input type="text" name="date" :placeholder="$store.i18n.t('timeline.form.datePlaceholder')" :value="$store.ui.modalData?.date || ''">
                    <p class="hint" x-text="$store.i18n.t('timeline.form.dateHint') || 'Fecha exacta del evento'"></p>
                </div>

                <!-- Era Input (Era Mode) -->
                <div class="form-group" x-show="dateMode === 'era'">
                    <label x-text="$store.i18n.t('timeline.form.era') || 'Era/Época'">Era</label>
                    <input type="text" name="era" :placeholder="$store.i18n.t('timeline.form.eraPlaceholder') || 'Ej: Era del Caos, Edad Media...'" :value="$store.ui.modalData?.era || ''">
                    <p class="hint" x-text="$store.i18n.t('timeline.form.eraHint') || 'Época o era en la que ocurre el evento'"></p>
                </div>

                <!-- Relative Mode Info -->
                <div class="form-group" x-show="dateMode === 'relative'">
                    <div style="padding: 16px; background: var(--bg-tertiary); border-radius: 8px;">
                        <i data-lucide="info" width="16" height="16"></i>
                        <span x-text="$store.i18n.t('timeline.form.relativeInfo') || 'El orden relativo se define arrastrando eventos en la vista de timeline'"></span>
                    </div>
                </div>

                <div class="form-divider"></div>

                <!-- Importance -->
                <div class="form-group">
                    <label x-text="$store.i18n.t('timeline.form.importance') || 'Importancia'">Importancia</label>
                    <div style="display: flex; gap: 8px;">
                        <button type="button" class="btn-secondary" :class="{ 'btn-primary': importance === 'low' }" @click="importance = 'low'" style="flex: 1;">
                            <span x-text="$store.i18n.t('timeline.importance.low') || 'Baja'">Baja</span>
                        </button>
                        <button type="button" class="btn-secondary" :class="{ 'btn-primary': importance === 'medium' }" @click="importance = 'medium'" style="flex: 1;">
                            <span x-text="$store.i18n.t('timeline.importance.medium') || 'Media'">Media</span>
                        </button>
                        <button type="button" class="btn-secondary" :class="{ 'btn-primary': importance === 'high' }" @click="importance = 'high'" style="flex: 1;">
                            <span x-text="$store.i18n.t('timeline.importance.high') || 'Alta'">Alta</span>
                        </button>
                    </div>
                </div>

                <!-- Description Rich Editor -->
                <div class="form-group" x-data="richEditorComponent({
                    placeholder: $store.i18n.t('timeline.form.descriptionPlaceholder'),
                    initialContent: $store.ui.modalData?.description || '',
                    enableMentions: true,
                    enableCommands: false
                })" x-init="() => { $el.dataset.field = 'description'; }">
                    <label x-text="$store.i18n.t('timeline.form.description')">Descripción</label>
                    <div x-ref="editorContainer" class="rich-editor-wrapper"></div>
                </div>

                <div class="form-divider"></div>

                <!-- Participants (Characters) -->
                <div class="form-group">
                    <label x-text="$store.i18n.t('timeline.form.participants') || 'Participantes'">Participantes</label>
                    <div style="max-height: 200px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 8px; padding: 8px;">
                        <template x-if="$store.project.characters.length === 0">
                            <p class="hint" x-text="$store.i18n.t('timeline.form.noCharacters') || 'No hay personajes creados'"></p>
                        </template>
                        <template x-for="char in $store.project.characters" :key="char.id">
                            <label style="display: flex; align-items: center; padding: 8px; cursor: pointer; border-radius: 4px;" :style="selectedParticipants.includes(char.id) ? 'background: var(--bg-tertiary);' : ''">
                                <input type="checkbox" :checked="selectedParticipants.includes(char.id)" @change="toggleParticipant(char.id)" style="margin-right: 8px;">
                                <span x-text="char.name"></span>
                            </label>
                        </template>
                    </div>
                </div>

                <!-- Location -->
                <div class="form-group">
                    <label x-text="$store.i18n.t('timeline.form.location') || 'Ubicación'">Ubicación</label>
                    <select x-model="selectedLocation" style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid var(--border-color); background: var(--bg-secondary); color: var(--text-primary);">
                        <option value="" x-text="$store.i18n.t('timeline.form.noLocation') || 'Sin ubicación'">Sin ubicación</option>
                        <template x-for="loc in $store.project.locations" :key="loc.id">
                            <option :value="loc.id" x-text="loc.name"></option>
                        </template>
                    </select>
                </div>

                <!-- Related Scenes -->
                <div class="form-group">
                    <label x-text="$store.i18n.t('timeline.form.relatedScenes') || 'Escenas Relacionadas'">Escenas Relacionadas</label>
                    <div style="max-height: 150px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 8px; padding: 8px;">
                        <template x-if="$store.project.scenes.length === 0">
                            <p class="hint" x-text="$store.i18n.t('timeline.form.noScenes') || 'No hay escenas creadas'"></p>
                        </template>
                        <template x-for="scene in $store.project.scenes" :key="scene.id">
                            <label style="display: flex; align-items: center; padding: 8px; cursor: pointer; border-radius: 4px;" :style="selectedScenes.includes(scene.id) ? 'background: var(--bg-tertiary);' : ''">
                                <input type="checkbox" :checked="selectedScenes.includes(scene.id)" @change="toggleScene(scene.id)" style="margin-right: 8px;">
                                <span x-text="scene.title"></span>
                            </label>
                        </template>
                    </div>
                </div>

                <!-- Related Chapters -->
                <div class="form-group">
                    <label x-text="$store.i18n.t('timeline.form.relatedChapters') || 'Capítulos Relacionados'">Capítulos Relacionados</label>
                    <div style="max-height: 150px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 8px; padding: 8px;">
                        <template x-if="$store.project.chapters.length === 0">
                            <p class="hint" x-text="$store.i18n.t('timeline.form.noChapters') || 'No hay capítulos creados'"></p>
                        </template>
                        <template x-for="chapter in $store.project.chapters" :key="chapter.id">
                            <label style="display: flex; align-items: center; padding: 8px; cursor: pointer; border-radius: 4px;" :style="selectedChapters.includes(chapter.id) ? 'background: var(--bg-tertiary);' : ''">
                                <input type="checkbox" :checked="selectedChapters.includes(chapter.id)" @change="toggleChapter(chapter.id)" style="margin-right: 8px;">
                                <span x-text="chapter.title"></span>
                            </label>
                        </template>
                    </div>
                </div>

                <!-- Tags -->
                <div class="form-group">
                    <label x-text="$store.i18n.t('timeline.form.tags') || 'Etiquetas'">Etiquetas</label>
                    <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                        <input type="text" x-model="tagInput" @keydown.enter.prevent="addTag()" :placeholder="$store.i18n.t('timeline.form.tagsPlaceholder') || 'Agregar etiqueta...'" style="flex: 1;">
                        <button type="button" class="btn-secondary" @click="addTag()">
                            <i data-lucide="plus" width="16" height="16"></i>
                        </button>
                    </div>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        <template x-for="tag in tags" :key="tag">
                            <span class="badge" style="display: flex; align-items: center; gap: 4px;">
                                <span x-text="tag"></span>
                                <button type="button" @click="removeTag(tag)" style="background: none; border: none; cursor: pointer; padding: 0; display: flex;">
                                    <i data-lucide="x" width="12" height="12"></i>
                                </button>
                            </span>
                        </template>
                    </div>
                </div>

                <!-- Notes Rich Editor -->
                <div class="form-group" x-data="richEditorComponent({
                    placeholder: $store.i18n.t('timeline.form.notes'),
                    initialContent: $store.ui.modalData?.notes || '',
                    enableMentions: true,
                    enableCommands: false
                })" x-init="() => { $el.dataset.field = 'notes'; }">
                    <label x-text="$store.i18n.t('timeline.form.notes')">Notas</label>
                    <div x-ref="editorContainer" class="rich-editor-wrapper"></div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn-secondary" @click="$store.ui.closeModal()" x-text="$store.i18n.t('common.cancel')">Cancelar</button>
                    <button type="submit" class="btn-primary" x-text="$store.ui.modalData?.id ? $store.i18n.t('common.save') : $store.i18n.t('common.create')">Guardar</button>
                </div>
            </form>
        </div>
    </div>
</div>
</template>
