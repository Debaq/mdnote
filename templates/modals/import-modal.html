<!-- Import Modal -->
<div class="legacy-modal" :class="{ 'active': $store.ui.modals.import }">
    <div class="legacy-modal-content">
        <div class="legacy-modal-header">
            <h2 x-text="$store.i18n.t('modals.import.title')">Importar Proyecto</h2>
            <button class="btn-close" @click="$store.ui.closeModal('import'); $store.ui.openModal('welcome')">
                <i data-lucide="x" width="20" height="20"></i>
            </button>
        </div>
        <div class="modal-body" x-data="{ file: null }">
            <p x-text="$store.i18n.t('modals.import.description')">Carga un proyecto desde archivo PLUMA (*.pluma)</p>
            <div style="margin-top: 20px;">
                <input type="file" accept=".pluma" @change="file = $event.target.files[0]" style="display: none;" id="import-file-input">
                <button class="btn-secondary" @click="$el.previousElementSibling.click()" style="width: 100%; padding: 40px; display: flex; flex-direction: column; align-items: center; gap: 12px;">
                    <i data-lucide="upload" width="32" height="32"></i>
                    <span x-text="file ? $store.i18n.t('modals.import.selected', {filename: file.name}) : $store.i18n.t('modals.import.selectFile')">Seleccionar archivo</span>
                </button>
                <template x-if="file">
                    <div style="margin-top: 12px; padding: 12px; background: var(--bg-tertiary); border-radius: 6px; font-size: 13px;">
                        <strong x-text="file.name"></strong>
                        <span style="color: var(--text-secondary);"> • </span>
                        <span x-text="(file.size / 1024).toFixed(2) + ' KB'" style="color: var(--text-secondary);"></span>
                    </div>
                </template>
            </div>
            <p class="hint" style="margin-top: 12px;" x-text="$store.i18n.t('modals.import.warning')">Esto creará un nuevo proyecto con los datos importados</p>
        </div>
        <div class="modal-footer">
            <button class="btn-secondary" @click="$store.ui.closeModal('import'); $store.ui.openModal('welcome')" x-text="$store.i18n.t('common.cancel')">Cancelar</button>
            <button class="btn-primary" @click="
                async function importProjectWithPassword() {
                    const fileInput = document.getElementById('import-file-input');
                    const file = fileInput.files[0];
                    if (!file) {
                        $store.ui.error('Error', $store.i18n.t('modals.import.errors.noFile'));
                        return;
                    }

                    // Función interna para intentar importar con contraseña opcional
                    async function tryImport(password = null) {
                        try {
                            const projectData = await window.storageManager.importProject(file, password);
                            $store.project.loadProject(projectData);
                            $store.ui.success($store.i18n.t('modals.import.success'), '');
                            $store.ui.closeModal('import');
                            fileInput.value = '';
                        } catch (error) {
                            // Verificar si el error es por encriptación
                            const errorMsg = error.message || '';
                            const isEncryptionError = errorMsg.includes('encriptado') ||
                                                     errorMsg.includes('contraseña') ||
                                                     errorMsg.includes('encrypted') ||
                                                     errorMsg.includes('password');

                            if (isEncryptionError && !password) {
                                // Mostrar modal de contraseña
                                $store.ui.modalData = {
                                    title: $store.i18n.t('modals.import.encryptedFile'),
                                    message: errorMsg,
                                    submitText: $store.i18n.t('common.import'),
                                    onSubmit: (enteredPassword) => {
                                        tryImport(enteredPassword);
                                    },
                                    onCancel: () => {
                                        // Usuario canceló, no hacer nada
                                    }
                                };
                                $store.ui.openModal('password');
                            } else {
                                // Otro error o contraseña incorrecta
                                $store.ui.error($store.i18n.t('modals.import.errors.failed'), errorMsg);
                            }
                        }
                    }

                    // Iniciar importación
                    await tryImport();
                }
                importProjectWithPassword();
            ">
                <i data-lucide="upload" width="16" height="16"></i>
                <span x-text="$store.i18n.t('common.import')">Importar</span>
            </button>
        </div>
    </div>
</div>