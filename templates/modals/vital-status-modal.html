<!-- Vital Status Modal -->
<template x-if="$store.ui.modals.vitalStatus">
<div class="legacy-modal active">
    <div class="legacy-modal-content" style="max-width: 700px;">
        <div class="legacy-modal-header">
            <h2>
                <i data-lucide="heart-pulse" width="20" height="20"></i>
                <span x-text="$store.i18nStore.t('modals.vitalStatus.title', { name: $store.ui.modalData?.character?.name })"></span>
            </h2>
            <button class="btn-close" @click="$store.ui.closeModal()">
                <i data-lucide="x" width="20" height="20"></i>
            </button>
        </div>
        <div class="modal-body" x-data="{
            showStatusForm: false,
            editingEntryIndex: null,

            getCharacter() {
                return $store.ui.modalData?.character || null;
            },

            addStatusEntry(form) {
                const character = this.getCharacter();
                if (!character) return;

                const statusData = {
                    status: form.querySelector('[name=newStatus]').value,
                    description: form.querySelector('[name=newDescription]').value,
                    notes: form.querySelector('[name=newNotes]').value || '',
                    eventId: form.querySelector('[name=newEvent]').value || null
                };

                $store.project.updateCharacterVitalStatus(character.id, statusData);

                $store.ui.success($store.i18nStore.t('vitalStatus.success.updated'), '');
                this.showStatusForm = false;
                form.reset();
                lucide.createIcons();
            },

            editStatusEntry(index, form) {
                const character = this.getCharacter();
                if (!character) return;

                const updatedData = {
                    status: form.querySelector('[name=editStatus]').value,
                    description: form.querySelector('[name=editDescription]').value,
                    notes: form.querySelector('[name=editNotes]').value || '',
                    eventId: form.querySelector('[name=editEvent]').value || null
                };

                $store.project.editCharacterVitalStatusEntry(character.id, index, updatedData);

                $store.ui.success($store.i18nStore.t('vitalStatus.success.entryUpdated'), '');
                this.editingEntryIndex = null;
                lucide.createIcons();
            },

            deleteStatusEntry(index) {
                const character = this.getCharacter();
                if (!character) return;

                if (character.vitalStatusHistory.length === 1) {
                    $store.ui.error('Error', $store.i18nStore.t('vitalStatus.errors.cannotDeleteLastEntry'));
                    return;
                }

                if (!confirm($store.i18nStore.t('vitalStatus.confirm.deleteEntry'))) return;

                $store.project.deleteCharacterVitalStatusEntry(character.id, index);

                $store.ui.success($store.i18nStore.t('vitalStatus.success.entryDeleted'), '');
                lucide.createIcons();
            },

            formatDate(timestamp) {
                if (!timestamp) return $store.i18nStore.t('common.dateUnknown');
                const date = new Date(timestamp);
                return date.toLocaleDateString('es-ES', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            },

            getEventName(eventId) {
                if (!eventId) return null;
                const event = $store.project.timeline.find(e => e.id === eventId);
                return event ? event.event : $store.i18nStore.t('timeline.eventUnknown');
            }
        }">
            <!-- Estado Actual -->
            <template x-if="getCharacter()">
                <div style="background: linear-gradient(135deg, rgba(74, 144, 226, 0.1) 0%, rgba(124, 179, 255, 0.05) 100%); padding: 16px; border-radius: 8px; border: 1px solid rgba(74, 144, 226, 0.2); margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                        <i data-lucide="activity" width="18" height="18" style="color: var(--accent);"></i>
                        <h4 style="margin: 0; font-size: 14px; font-weight: 600;" x-text="$store.i18nStore.t('vitalStatus.currentState')"></h4>
                    </div>
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <span class="badge"
                              style="font-size: 14px; padding: 6px 12px;"
                              :style="'background: ' + $store.project.getVitalStatusInfo(getCharacter().currentVitalStatus).color + '22; color: ' + $store.project.getVitalStatusInfo(getCharacter().currentVitalStatus).color + '; border: 1px solid ' + $store.project.getVitalStatusInfo(getCharacter().currentVitalStatus).color + '44;'"
                              x-text="$store.project.getVitalStatusInfo(getCharacter().currentVitalStatus).label"></span>
                    </div>
                </div>
            </template>

            <!-- Historial de Estados -->
            <div style="margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <h4 style="margin: 0; display: flex; align-items: center; gap: 8px;">
                        <i data-lucide="clock" width="18" height="18"></i>
                        <span x-text="$store.i18nStore.t('vitalStatus.history')"></span>
                    </h4>
                    <button type="button"
                            class="btn-primary btn-sm"
                            @click="showStatusForm = !showStatusForm">
                        <i data-lucide="plus" width="14" height="14"></i>
                        <span x-text="showStatusForm ? $store.i18nStore.t('common.cancel') : $store.i18nStore.t('vitalStatus.changeStatus')"></span>
                    </button>
                </div>

                <!-- Formulario para agregar nuevo cambio -->
                <div x-show="showStatusForm"
                     x-transition
                     style="background: var(--bg-tertiary); padding: 16px; border-radius: 8px; margin-bottom: 16px; border: 2px dashed var(--border);">
                    <h5 style="margin: 0 0 12px 0; font-size: 13px; font-weight: 600;" x-text="$store.i18nStore.t('vitalStatus.changeStatusTitle')"></h5>
                    <form @submit.prevent="addStatusEntry($el)">
                        <div class="form-group">
                            <label x-text="$store.i18nStore.t('vitalStatus.form.newStatus')"></label>
                            <select name="newStatus" required>
                                <optgroup :label="$store.i18nStore.t('vitalStatus.groups.aliveActive')">
                                    <option value="alive" x-text="$store.i18nStore.t('vitalStatus.statuses.alive')"></option>
                                    <option value="healthy" x-text="$store.i18nStore.t('vitalStatus.statuses.healthy')"></option>
                                    <option value="injured" x-text="$store.i18nStore.t('vitalStatus.statuses.injured')"></option>
                                    <option value="sick" x-text="$store.i18nStore.t('vitalStatus.statuses.sick')"></option>
                                    <option value="recovering" x-text="$store.i18nStore.t('vitalStatus.statuses.recovering')"></option>
                                    <option value="imprisoned" x-text="$store.i18nStore.t('vitalStatus.statuses.imprisoned')"></option>
                                </optgroup>
                                <optgroup :label="$store.i18nStore.t('vitalStatus.groups.birthOrigin')">
                                    <option value="born" x-text="$store.i18nStore.t('vitalStatus.statuses.born')"></option>
                                    <option value="created" x-text="$store.i18nStore.t('vitalStatus.statuses.created')"></option>
                                    <option value="appeared" x-text="$store.i18nStore.t('vitalStatus.statuses.appeared')"></option>
                                    <option value="awakened" x-text="$store.i18nStore.t('vitalStatus.statuses.awakened')"></option>
                                    <option value="reborn" x-text="$store.i18nStore.t('vitalStatus.statuses.reborn')"></option>
                                </optgroup>
                                <optgroup :label="$store.i18nStore.t('vitalStatus.groups.death')">
                                    <option value="dead" x-text="$store.i18nStore.t('vitalStatus.statuses.dead')"></option>
                                    <option value="killed" x-text="$store.i18nStore.t('vitalStatus.statuses.killed')"></option>
                                    <option value="executed" x-text="$store.i18nStore.t('vitalStatus.statuses.executed')"></option>
                                    <option value="sacrificed" x-text="$store.i18nStore.t('vitalStatus.statuses.sacrificed')"></option>
                                    <option value="died_natural" x-text="$store.i18nStore.t('vitalStatus.statuses.diedNatural')"></option>
                                    <option value="died_battle" x-text="$store.i18nStore.t('vitalStatus.statuses.diedBattle')"></option>
                                </optgroup>
                                <optgroup :label="$store.i18nStore.t('vitalStatus.groups.disappearance')">
                                    <option value="missing" x-text="$store.i18nStore.t('vitalStatus.statuses.missing')"></option>
                                    <option value="lost" x-text="$store.i18nStore.t('vitalStatus.statuses.lost')"></option>
                                    <option value="kidnapped" x-text="$store.i18nStore.t('vitalStatus.statuses.kidnapped')"></option>
                                    <option value="exiled" x-text="$store.i18nStore.t('vitalStatus.statuses.exiled')"></option>
                                    <option value="vanished" x-text="$store.i18nStore.t('vitalStatus.statuses.vanished')"></option>
                                    <option value="escaped" x-text="$store.i18nStore.t('vitalStatus.statuses.escaped')"></option>
                                </optgroup>
                                <optgroup :label="$store.i18nStore.t('vitalStatus.groups.transformation')">
                                    <option value="transformed" x-text="$store.i18nStore.t('vitalStatus.statuses.transformed')"></option>
                                    <option value="cursed" x-text="$store.i18nStore.t('vitalStatus.statuses.cursed')"></option>
                                    <option value="possessed" x-text="$store.i18nStore.t('vitalStatus.statuses.possessed')"></option>
                                    <option value="corrupted" x-text="$store.i18nStore.t('vitalStatus.statuses.corrupted')"></option>
                                    <option value="ascended" x-text="$store.i18nStore.t('vitalStatus.statuses.ascended')"></option>
                                </optgroup>
                                <optgroup :label="$store.i18nStore.t('vitalStatus.groups.unknown')">
                                    <option value="unknown" x-text="$store.i18nStore.t('vitalStatus.statuses.unknown')"></option>
                                    <option value="presumed_dead" x-text="$store.i18nStore.t('vitalStatus.statuses.presumedDead')"></option>
                                    <option value="presumed_alive" x-text="$store.i18nStore.t('vitalStatus.statuses.presumedAlive')"></option>
                                </optgroup>
                            </select>
                        </div>

                        <div class="form-group">
                            <label x-text="$store.i18nStore.t('vitalStatus.form.whatHappened')"></label>
                            <textarea name="newDescription"
                                      rows="2"
                                      required
                                      :placeholder="$store.i18nStore.t('vitalStatus.form.whatHappenedPlaceholder')"></textarea>
                        </div>

                        <div class="form-group">
                            <label>
                                <i data-lucide="calendar" width="14" height="14"></i>
                                <span x-text="$store.i18nStore.t('vitalStatus.form.associatedEvent')"></span>
                            </label>
                            <select name="newEvent">
                                <option value="" x-text="$store.i18nStore.t('timeline.noSpecificEvent')"></option>
                                <template x-for="event in $store.project.timeline" :key="event.id">
                                    <option :value="event.id" x-text="event.event"></option>
                                </template>
                            </select>
                        </div>

                        <div class="form-group">
                            <label x-text="$store.i18nStore.t('vitalStatus.form.additionalNotes')"></label>
                            <textarea name="newNotes"
                                      rows="2"
                                      :placeholder="$store.i18nStore.t('vitalStatus.form.additionalNotesPlaceholder')"></textarea>
                        </div>

                        <div style="display: flex; gap: 8px; justify-content: flex-end;">
                            <button type="button" class="btn-secondary btn-sm" @click="showStatusForm = false" x-text="$store.i18nStore.t('common.cancel')">
                            </button>
                            <button type="submit" class="btn-primary btn-sm" x-text="$store.i18nStore.t('vitalStatus.saveChange')">
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Lista de historial -->
                <template x-if="getCharacter() && getCharacter().vitalStatusHistory">
                    <div style="position: relative;">
                        <!-- Línea temporal vertical -->
                        <div style="position: absolute; left: 11px; top: 0; bottom: 0; width: 2px; background: var(--border);"></div>

                        <div style="display: flex; flex-direction: column; gap: 16px;">
                            <template x-for="(entry, idx) in [...getCharacter().vitalStatusHistory].reverse()" :key="idx">
                                <div style="position: relative; padding-left: 36px;" x-data="{ actualIndex: getCharacter().vitalStatusHistory.length - 1 - idx }">
                                    <!-- Punto en la línea temporal -->
                                    <div style="position: absolute; left: 0; top: 4px; width: 24px; height: 24px; background: var(--bg-secondary); border-radius: 50%; display: flex; align-items: center; justify-content: center;"
                                         :style="'border: 2px solid ' + $store.project.getVitalStatusInfo(entry.status).color">
                                        <div style="width: 8px; height: 8px; border-radius: 50%;"
                                             :style="'background: ' + $store.project.getVitalStatusInfo(entry.status).color"></div>
                                    </div>

                                    <!-- Vista normal (no editando) -->
                                    <div x-show="editingEntryIndex !== actualIndex"
                                         style="background: var(--bg-tertiary); padding: 12px; border-radius: 6px; border: 1px solid var(--border);">
                                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                            <div>
                                                <span class="badge"
                                                      :style="'background: ' + $store.project.getVitalStatusInfo(entry.status).color + '22; color: ' + $store.project.getVitalStatusInfo(entry.status).color + '; border: 1px solid ' + $store.project.getVitalStatusInfo(entry.status).color + '44;'"
                                                      x-text="$store.project.getVitalStatusInfo(entry.status).label"></span>
                                            </div>
                                            <div style="display: flex; align-items: center; gap: 8px;">
                                                <div style="font-size: 11px; color: var(--text-tertiary);" x-text="formatDate(entry.timestamp)"></div>
                                                <button type="button"
                                                        class="btn-icon btn-sm"
                                                        @click="editingEntryIndex = actualIndex"
                                                        :title="$store.i18nStore.t('common.edit')">
                                                    <i data-lucide="edit-2" width="14" height="14"></i>
                                                </button>
                                                <template x-if="getCharacter().vitalStatusHistory.length > 1">
                                                    <button type="button"
                                                            class="btn-icon btn-sm"
                                                            @click="deleteStatusEntry(actualIndex)"
                                                            :title="$store.i18nStore.t('common.delete')"
                                                            style="color: var(--danger);">
                                                        <i data-lucide="trash-2" width="14" height="14"></i>
                                                    </button>
                                                </template>
                                            </div>
                                        </div>
                                        <div style="font-size: 13px; margin-bottom: 6px;" x-text="entry.description || $store.i18nStore.t('common.noDescription')"></div>
                                        <template x-if="entry.eventId && getEventName(entry.eventId)">
                                            <div style="font-size: 11px; color: var(--text-tertiary); display: flex; align-items: center; gap: 4px;">
                                                <i data-lucide="calendar" width="12" height="12"></i>
                                                <span x-text="getEventName(entry.eventId)"></span>
                                            </div>
                                        </template>
                                        <template x-if="entry.notes">
                                            <div style="font-size: 11px; color: var(--text-tertiary); margin-top: 6px; font-style: italic;" x-text="entry.notes"></div>
                                        </template>
                                    </div>

                                    <!-- Formulario de edición inline -->
                                    <div x-show="editingEntryIndex === actualIndex"
                                         x-transition
                                         style="background: var(--bg-tertiary); padding: 12px; border-radius: 6px; border: 2px solid var(--accent);">
                                        <h5 style="margin: 0 0 12px 0; font-size: 13px; font-weight: 600;" x-text="$store.i18nStore.t('vitalStatus.editingEntry')"></h5>
                                        <form @submit.prevent="editStatusEntry(actualIndex, $el)">
                                            <div class="form-group">
                                                <label x-text="$store.i18nStore.t('vitalStatus.form.status')"></label>
                                                <select name="editStatus" required>
                                                    <optgroup :label="$store.i18nStore.t('vitalStatus.groups.aliveActive')">
                                                        <option value="alive" :selected="entry.status === 'alive'" x-text="$store.i18nStore.t('vitalStatus.statuses.alive')"></option>
                                                        <option value="healthy" :selected="entry.status === 'healthy'" x-text="$store.i18nStore.t('vitalStatus.statuses.healthy')"></option>
                                                        <option value="injured" :selected="entry.status === 'injured'" x-text="$store.i18nStore.t('vitalStatus.statuses.injured')"></option>
                                                        <option value="sick" :selected="entry.status === 'sick'" x-text="$store.i18nStore.t('vitalStatus.statuses.sick')"></option>
                                                        <option value="recovering" :selected="entry.status === 'recovering'" x-text="$store.i18nStore.t('vitalStatus.statuses.recovering')"></option>
                                                        <option value="imprisoned" :selected="entry.status === 'imprisoned'" x-text="$store.i18nStore.t('vitalStatus.statuses.imprisoned')"></option>
                                                    </optgroup>
                                                    <optgroup :label="$store.i18nStore.t('vitalStatus.groups.birthOrigin')">
                                                        <option value="born" :selected="entry.status === 'born'" x-text="$store.i18nStore.t('vitalStatus.statuses.born')"></option>
                                                        <option value="created" :selected="entry.status === 'created'" x-text="$store.i18nStore.t('vitalStatus.statuses.created')"></option>
                                                        <option value="appeared" :selected="entry.status === 'appeared'" x-text="$store.i18nStore.t('vitalStatus.statuses.appeared')"></option>
                                                        <option value="awakened" :selected="entry.status === 'awakened'" x-text="$store.i18nStore.t('vitalStatus.statuses.awakened')"></option>
                                                        <option value="reborn" :selected="entry.status === 'reborn'" x-text="$store.i18nStore.t('vitalStatus.statuses.reborn')"></option>
                                                    </optgroup>
                                                    <optgroup :label="$store.i18nStore.t('vitalStatus.groups.death')">
                                                        <option value="dead" :selected="entry.status === 'dead'" x-text="$store.i18nStore.t('vitalStatus.statuses.dead')"></option>
                                                        <option value="killed" :selected="entry.status === 'killed'" x-text="$store.i18nStore.t('vitalStatus.statuses.killed')"></option>
                                                        <option value="executed" :selected="entry.status === 'executed'" x-text="$store.i18nStore.t('vitalStatus.statuses.executed')"></option>
                                                        <option value="sacrificed" :selected="entry.status === 'sacrificed'" x-text="$store.i18nStore.t('vitalStatus.statuses.sacrificed')"></option>
                                                        <option value="died_natural" :selected="entry.status === 'died_natural'" x-text="$store.i18nStore.t('vitalStatus.statuses.diedNatural')"></option>
                                                        <option value="died_battle" :selected="entry.status === 'died_battle'" x-text="$store.i18nStore.t('vitalStatus.statuses.diedBattle')"></option>
                                                    </optgroup>
                                                    <optgroup :label="$store.i18nStore.t('vitalStatus.groups.disappearance')">
                                                        <option value="missing" :selected="entry.status === 'missing'" x-text="$store.i18nStore.t('vitalStatus.statuses.missing')"></option>
                                                        <option value="lost" :selected="entry.status === 'lost'" x-text="$store.i18nStore.t('vitalStatus.statuses.lost')"></option>
                                                        <option value="kidnapped" :selected="entry.status === 'kidnapped'" x-text="$store.i18nStore.t('vitalStatus.statuses.kidnapped')"></option>
                                                        <option value="exiled" :selected="entry.status === 'exiled'" x-text="$store.i18nStore.t('vitalStatus.statuses.exiled')"></option>
                                                        <option value="vanished" :selected="entry.status === 'vanished'" x-text="$store.i18nStore.t('vitalStatus.statuses.vanished')"></option>
                                                        <option value="escaped" :selected="entry.status === 'escaped'" x-text="$store.i18nStore.t('vitalStatus.statuses.escaped')"></option>
                                                    </optgroup>
                                                    <optgroup :label="$store.i18nStore.t('vitalStatus.groups.transformation')">
                                                        <option value="transformed" :selected="entry.status === 'transformed'" x-text="$store.i18nStore.t('vitalStatus.statuses.transformed')"></option>
                                                        <option value="cursed" :selected="entry.status === 'cursed'" x-text="$store.i18nStore.t('vitalStatus.statuses.cursed')"></option>
                                                        <option value="possessed" :selected="entry.status === 'possessed'" x-text="$store.i18nStore.t('vitalStatus.statuses.possessed')"></option>
                                                        <option value="corrupted" :selected="entry.status === 'corrupted'" x-text="$store.i18nStore.t('vitalStatus.statuses.corrupted')"></option>
                                                        <option value="ascended" :selected="entry.status === 'ascended'" x-text="$store.i18nStore.t('vitalStatus.statuses.ascended')"></option>
                                                    </optgroup>
                                                    <optgroup :label="$store.i18nStore.t('vitalStatus.groups.unknown')">
                                                        <option value="unknown" :selected="entry.status === 'unknown'" x-text="$store.i18nStore.t('vitalStatus.statuses.unknown')"></option>
                                                        <option value="presumed_dead" :selected="entry.status === 'presumed_dead'" x-text="$store.i18nStore.t('vitalStatus.statuses.presumedDead')"></option>
                                                        <option value="presumed_alive" :selected="entry.status === 'presumed_alive'" x-text="$store.i18nStore.t('vitalStatus.statuses.presumedAlive')"></option>
                                                    </optgroup>
                                                </select>
                                            </div>

                                            <div class="form-group">
                                                <label x-text="$store.i18nStore.t('vitalStatus.form.description')"></label>
                                                <textarea name="editDescription"
                                                          rows="2"
                                                          required
                                                          x-text="entry.description"></textarea>
                                            </div>

                                            <div class="form-group">
                                                <label>
                                                    <i data-lucide="calendar" width="14" height="14"></i>
                                                    <span x-text="$store.i18nStore.t('vitalStatus.form.associatedEvent')"></span>
                                                </label>
                                                <select name="editEvent">
                                                    <option value="" x-text="$store.i18nStore.t('timeline.noSpecificEvent')"></option>
                                                    <template x-for="event in $store.project.timeline" :key="event.id">
                                                        <option :value="event.id"
                                                                :selected="event.id === entry.eventId"
                                                                x-text="event.event"></option>
                                                    </template>
                                                </select>
                                            </div>

                                            <div class="form-group">
                                                <label x-text="$store.i18nStore.t('vitalStatus.form.additionalNotes')"></label>
                                                <textarea name="editNotes"
                                                          rows="2"
                                                          x-text="entry.notes"></textarea>
                                            </div>

                                            <div style="display: flex; gap: 8px; justify-content: flex-end;">
                                                <button type="button" class="btn-secondary btn-sm" @click="editingEntryIndex = null" x-text="$store.i18nStore.t('common.cancel')">
                                                </button>
                                                <button type="submit" class="btn-primary btn-sm" x-text="$store.i18nStore.t('common.saveChanges')">
                                                </button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </template>
            </div>

            <!-- Footer con acciones -->
            <div class="modal-footer" style="justify-content: flex-end;">
                <button type="button" class="btn-secondary" @click="$store.ui.closeModal()" x-text="$store.i18nStore.t('common.close')">
                </button>
            </div>
        </div>
    </div>
</div>
</template>
