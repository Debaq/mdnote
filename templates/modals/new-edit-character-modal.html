<!-- New/Edit Character Modal -->
<template x-if="$store.ui.modals.newCharacter || $store.ui.modals.editCharacter">
<div class="legacy-modal active">
    <div class="legacy-modal-content">
        <div class="legacy-modal-header">
            <h2 x-text="$store.ui.modals.editCharacter ? $store.i18n.t('characters.edit') : $store.i18n.t('characters.new')">Personaje</h2>
            <button class="btn-close" @click="$store.ui.closeModal()">
                <i data-lucide="x" width="20" height="20"></i>
            </button>
        </div>
        <div class="modal-body" x-data="{ submitForm(form) {
            // Obtener el componente del avatar por su ID espec√≠fico
            let avatarComponent = form.querySelector('[data-avatar-component]')?.__x?.$data;

            // Obtener contenido de los RichEditors
            let description = '';
            let personality = '';
            let background = '';
            let notes = '';

            // Buscar los componentes de RichEditor por el dataset.field
            let descEditor = form.querySelector('[data-field=description]')?.__x?.$data;
            let persEditor = form.querySelector('[data-field=personality]')?.__x?.$data;
            let backEditor = form.querySelector('[data-field=background]')?.__x?.$data;
            let noteEditor = form.querySelector('[data-field=notes]')?.__x?.$data;

            // Obtener el contenido del editor, preservando el valor existente si el editor no devuelve nada v√°lido
            description = descEditor?.getContent() ?? $store.ui.modalData?.description ?? '';
            personality = persEditor?.getContent() ?? $store.ui.modalData?.personality ?? '';
            background = backEditor?.getContent() ?? $store.ui.modalData?.background ?? '';
            notes = noteEditor?.getContent() ?? $store.ui.modalData?.notes ?? '';

            let formData = {
                name: form.querySelector('[name=name]').value,
                role: form.querySelector('[name=role]').value,
                description: description,
                personality: personality,
                background: background,
                notes: notes,
                relationships: $store.ui.modalData?.relationships || [],
                avatar: avatarComponent?.currentAvatar || null
            };
            if ($store.ui.modalData?.id) {
                $store.project.updateCharacter($store.ui.modalData.id, formData);
                $store.ui.success($store.i18n.t('notifications.success.characterUpdated'), '');
            } else {
                $store.project.addCharacter(formData);
                $store.ui.success($store.i18n.t('notifications.success.characterCreated'), '');
            }
            $store.ui.closeModal();
            form.reset();
            lucide.createIcons();
        }}">
            <form @submit.prevent="submitForm($el)">
                <!-- Avatar Section -->
                <div class="form-group" data-avatar-component x-data="{
                    currentAvatar: $store.ui.modalData?.avatar || null,
                    openAvatarSelector() {
                        const avatarCtx = this;
                        $store.ui.openModal('avatarSelector', {
                            name: $el.closest('form').querySelector('[name=name]').value || 'Preview',
                            onSelect: (avatar) => {
                                avatarCtx.currentAvatar = avatar;
                            }
                        });
                    }
                }">
                    <label x-text="$store.i18n.t('characters.form.avatar') || 'Avatar'"></label>
                    <div class="flex gap-md items-center">
                        <!-- Preview del avatar -->
                        <div class="avatar-preview" style="width: 80px; height: 80px; border-radius: 12px; overflow: hidden; background: var(--bg-tertiary); display: flex; align-items: center; justify-content: center; border: 2px solid var(--border);">
                            <template x-if="currentAvatar && currentAvatar.url">
                                <img :src="currentAvatar.url" style="width: 100%; height: 100%; object-fit: cover;">
                            </template>
                            <template x-if="!currentAvatar || !currentAvatar.url">
                                <i data-lucide="user" width="32" height="32" style="color: var(--text-tertiary);"></i>
                            </template>
                        </div>

                        <!-- Botones -->
                        <div class="flex-1">
                            <button type="button" class="btn-secondary w-full mb-sm" @click="openAvatarSelector()">
                                <i data-lucide="image" width="16" height="16"></i>
                                <span x-text="currentAvatar ? ($store.i18n.t('avatars.change') || 'Cambiar Avatar') : ($store.i18n.t('avatars.select') || 'Seleccionar Avatar')"></span>
                            </button>
                            <template x-if="currentAvatar">
                                <button type="button" class="btn-secondary w-full" @click="currentAvatar = null" style="font-size: 12px; padding: 6px 12px;">
                                    <i data-lucide="trash-2" width="14" height="14"></i>
                                    <span x-text="$store.i18n.t('common.remove') || 'Quitar'"></span>
                                </button>
                            </template>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label x-text="$store.i18n.t('characters.form.name')">Nombre</label>
                    <input type="text" name="name" required :placeholder="$store.i18n.t('characters.form.namePlaceholder')" :value="$store.ui.modalData?.name || ''">
                </div>
                <div class="form-group">
                    <label x-text="$store.i18n.t('characters.form.role')">Rol</label>
                    <select name="role">
                        <option value="protagonist" :selected="$store.ui.modalData?.role === 'protagonist'" x-text="$store.i18n.t('characters.form.roles.protagonist')">Protagonista</option>
                        <option value="antagonist" :selected="$store.ui.modalData?.role === 'antagonist'" x-text="$store.i18n.t('characters.form.roles.antagonist')">Antagonista</option>
                        <option value="secondary" :selected="!$store.ui.modalData || $store.ui.modalData?.role === 'secondary'" x-text="$store.i18n.t('characters.form.roles.secondary')">Secundario</option>
                        <option value="supporting" :selected="$store.ui.modalData?.role === 'supporting'" x-text="$store.i18n.t('characters.form.roles.supporting')">De apoyo</option>
                    </select>
                </div>
                <!-- Description Rich Editor -->
                <div class="form-group" x-data="richEditorComponent({
                    placeholder: $store.i18n.t('characters.form.descriptionPlaceholder'),
                    initialContent: $store.ui.modalData?.description || '',
                    enableMentions: false
                })" x-init="() => { $el.dataset.field = 'description'; }">
                    <label x-text="$store.i18n.t('characters.form.description')">Descripci√≥n F√≠sica</label>
                    <div x-ref="editorContainer" class="rich-editor-wrapper"></div>
                </div>

                <!-- Personality Rich Editor -->
                <div class="form-group" x-data="richEditorComponent({
                    placeholder: $store.i18n.t('characters.form.personalityPlaceholder'),
                    initialContent: $store.ui.modalData?.personality || '',
                    enableMentions: false
                })" x-init="() => { $el.dataset.field = 'personality'; }">
                    <label x-text="$store.i18n.t('characters.form.personality')">Personalidad</label>
                    <div x-ref="editorContainer" class="rich-editor-wrapper"></div>
                </div>

                <!-- Background Rich Editor -->
                <div class="form-group" x-data="richEditorComponent({
                    placeholder: $store.i18n.t('characters.form.backgroundPlaceholder'),
                    initialContent: $store.ui.modalData?.background || '',
                    enableMentions: true
                })" x-init="() => { $el.dataset.field = 'background'; }">
                    <label x-text="$store.i18n.t('characters.form.background')">Historia de Fondo</label>
                    <div x-ref="editorContainer" class="rich-editor-wrapper"></div>
                </div>

                <!-- Notes Rich Editor -->
                <div class="form-group" x-data="richEditorComponent({
                    placeholder: $store.i18n.t('characters.form.notesPlaceholder'),
                    initialContent: $store.ui.modalData?.notes || '',
                    enableMentions: true
                })" x-init="() => { $el.dataset.field = 'notes'; }">
                    <label x-text="$store.i18n.t('characters.form.notes')">Notas Adicionales</label>
                    <div x-ref="editorContainer" class="rich-editor-wrapper"></div>
                </div>
                
                <!-- Relaciones con otros personajes -->
                <div class="form-group">
                    <label x-text="$store.i18n.t('characters.form.relationships')">Relaciones con otros personajes</label>
                    <div class="bg-tertiary rounded-lg p-lg">
                        <div x-data="{
                            newRelationship: { characterId: '', type: 'friend', description: '' },
                            get availableCharacters() {
                                return $store.project.characters.filter(c =>
                                    c.id !== $store.ui.modalData?.id &&
                                    !($store.ui.modalData?.relationships || []).some(r => r.characterId === c.id)
                                );
                            },
                            init() {
                                // Inicializar relationships si no existe
                                if ($store.ui.modalData && !$store.ui.modalData.relationships) {
                                    $store.ui.modalData.relationships = [];
                                }
                                // Actualizar characterId cuando cambien los disponibles
                                this.$watch('availableCharacters', (chars) => {
                                    if (!this.newRelationship.characterId && chars.length > 0) {
                                        this.newRelationship.characterId = chars[0].id;
                                    }
                                });
                            }
                        }">
                            <template x-for="relation in $store.ui.modalData?.relationships || []" :key="relation.characterId">
                                <div class="relationship-item flex items-center gap-md p-md bg-secondary rounded-lg mb-md"
                                     :class="{
                                         'border-l-4 border-green-500': ['friend', 'ally', 'love'].includes(relation.currentType || relation.type),
                                         'border-l-4 border-red-500': ['enemy', 'rival', 'archenemy'].includes(relation.currentType || relation.type),
                                         'border-l-4 border-blue-500': ['family', 'guardian', 'ward'].includes(relation.currentType || relation.type),
                                         'border-l-4 border-yellow-500': ['colleague', 'mentor', 'teacher'].includes(relation.currentType || relation.type)
                                     }" style="position: relative; padding-left: 16px;">
                                    <!-- Icono del tipo de relaci√≥n -->
                                    <div class="text-2xl" style="width: 32px; text-align: center;" x-text="(() => {
                                        const icons = {
                                            friend: 'ü§ù', ally: 'üõ°Ô∏è', love: '‚ù§Ô∏è', crush: 'üíï', ex: 'üíî',
                                            family: 'üë®‚Äçüë©‚Äçüëß', guardian: 'üë§', ward: 'üßí',
                                            enemy: '‚öîÔ∏è', rival: 'ü•ä', archenemy: 'üíÄ',
                                            mentor: 'üéì', teacher: 'üìö', student: 'üìù',
                                            colleague: 'üíº', boss: 'üëî', subordinate: 'üìã',
                                            acquaintance: 'üëã', neighbor: 'üèòÔ∏è',
                                            hero: 'ü¶∏', villain: 'ü¶π', sidekick: 'ü¶∏‚Äç‚ôÇÔ∏è',
                                            collaborator: 'ü§ù', businessPartner: 'üí∞', partner: 'ü§ù',
                                            rivalLove: 'üíò'
                                        };
                                        return icons[relation.currentType || relation.type] || 'üë§';
                                    })()"></div>

                                    <div class="flex-1">
                                        <div class="font-semibold" style="color: var(--text-primary);" x-text="(() => {
                                            const relatedChar = $store.project.getCharacter(relation.characterId);
                                            return relatedChar ? relatedChar.name : $store.i18n.t('characters.unknownCharacter');
                                        })()"></div>
                                        <div class="text-xs" style="color: var(--accent);" x-text="$store.i18n.t('characters.form.relationTypes.' + (relation.currentType || relation.type))"></div>
                                    </div>

                                    <button type="button" class="btn-icon" @click="() => {
                                        if ($store.ui.modalData && $store.ui.modalData.relationships) {
                                            $store.ui.modalData.relationships = $store.ui.modalData.relationships.filter(r => r.characterId !== relation.characterId);
                                        }
                                    }">
                                        <i data-lucide="x" width="16" height="16"></i>
                                    </button>
                                </div>
                            </template>

                            <div class="flex gap-md mt-lg">
                                <select x-model="newRelationship.characterId" class="flex-1 p-md bg-primary border rounded-lg" x-bind:disabled="!availableCharacters || availableCharacters.length === 0">
                                    <template x-if="!availableCharacters || availableCharacters.length === 0">
                                        <option value="" x-text="$store.i18n.t('characters.form.noCharactersAvailable')"></option>
                                    </template>
                                    <template x-for="char in availableCharacters" :key="char.id">
                                        <option :value="char.id" x-text="char.name"></option>
                                    </template>
                                </select>
                                <select x-model="newRelationship.type" class="p-md bg-primary border rounded-lg">
                                    <optgroup :label="$store.i18n.t('characters.form.relationGroups.personal')">
                                        <option value="friend" x-text="$store.i18n.t('characters.form.relationTypes.friend')">Amigo</option>
                                        <option value="love" x-text="$store.i18n.t('characters.form.relationTypes.love')">Rom√°ntico</option>
                                        <option value="acquaintance" x-text="$store.i18n.t('characters.form.relationTypes.acquaintance')">Conocido</option>
                                        <option value="neighbor" x-text="$store.i18n.t('characters.form.relationTypes.neighbor')">Vecino</option>
                                        <option value="ally" x-text="$store.i18n.t('characters.form.relationTypes.ally')">Aliado</option>
                                        <option value="rival" x-text="$store.i18n.t('characters.form.relationTypes.rival')">Rival</option>
                                        <option value="ex" x-text="$store.i18n.t('characters.form.relationTypes.ex')">Ex</option>
                                        <option value="crush" x-text="$store.i18n.t('characters.form.relationTypes.crush')">Crush</option>
                                    </optgroup>
                                    <optgroup :label="$store.i18n.t('characters.form.relationGroups.family')">
                                        <option value="family" x-text="$store.i18n.t('characters.form.relationTypes.family')">Familia</option>
                                        <option value="guardian" x-text="$store.i18n.t('characters.form.relationTypes.guardian')">Guardi√°n</option>
                                        <option value="ward" x-text="$store.i18n.t('characters.form.relationTypes.ward')">Tutelado</option>
                                    </optgroup>
                                    <optgroup :label="$store.i18n.t('characters.form.relationGroups.professional')">
                                        <option value="colleague" x-text="$store.i18n.t('characters.form.relationTypes.colleague')">Colega</option>
                                        <option value="collaborator" x-text="$store.i18n.t('characters.form.relationTypes.collaborator')">Colaborador</option>
                                        <option value="mentor" x-text="$store.i18n.t('characters.form.relationTypes.mentor')">Mentor</option>
                                        <option value="teacher" x-text="$store.i18n.t('characters.form.relationTypes.teacher')">Profesor</option>
                                        <option value="student" x-text="$store.i18n.t('characters.form.relationTypes.student')">Estudiante</option>
                                        <option value="boss" x-text="$store.i18n.t('characters.form.relationTypes.boss')">Jefe</option>
                                        <option value="subordinate" x-text="$store.i18n.t('characters.form.relationTypes.subordinate')">Subordinado</option>
                                        <option value="businessPartner" x-text="$store.i18n.t('characters.form.relationTypes.businessPartner')">Socio de Negocios</option>
                                        <option value="partner" x-text="$store.i18n.t('characters.form.relationTypes.partner')">Socio</option>
                                    </optgroup>
                                    <optgroup :label="$store.i18n.t('characters.form.relationGroups.fiction')">
                                        <option value="hero" x-text="$store.i18n.t('characters.form.relationTypes.hero')">H√©roe</option>
                                        <option value="villain" x-text="$store.i18n.t('characters.form.relationTypes.villain')">Villano</option>
                                        <option value="sidekick" x-text="$store.i18n.t('characters.form.relationTypes.sidekick')">Compa√±ero</option>
                                        <option value="archenemy" x-text="$store.i18n.t('characters.form.relationTypes.archenemy')">Arquienemigo</option>
                                        <option value="rivalLove" x-text="$store.i18n.t('characters.form.relationTypes.rivalLove')">Rival Amoroso</option>
                                    </optgroup>
                                    <optgroup :label="$store.i18n.t('characters.form.relationGroups.conflict')">
                                        <option value="enemy" x-text="$store.i18n.t('characters.form.relationTypes.enemy')">Enemigo</option>
                                    </optgroup>
                                </select>
                                <button type="button" class="btn-primary flex-shrink-0" @click="() => {
                                    if (!$store.ui.modalData) return;
                                    if (newRelationship.characterId && !($store.ui.modalData.relationships || []).some(r => r.characterId === newRelationship.characterId)) {
                                        $store.ui.modalData.relationships = [...($store.ui.modalData.relationships || []), { ...newRelationship }];
                                        // Reset y seleccionar siguiente disponible
                                        const nextAvailable = availableCharacters.find(c => c.id !== newRelationship.characterId);
                                        newRelationship.characterId = nextAvailable?.id || '';
                                        newRelationship.type = 'friend';
                                        newRelationship.description = '';
                                    }
                                }" x-bind:disabled="!newRelationship.characterId || availableCharacters.length === 0">
                                    <i data-lucide="plus" width="16" height="16"></i>
                                </button>
                            </div>
                            <small class="text-tertiary text-xs mt-md" style="display: block;" x-text="$store.i18n.t('characters.form.relationshipsHint')"></small>
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" @click="$store.ui.closeModal()" x-text="$store.i18n.t('common.cancel')">Cancelar</button>
                    <button type="submit" class="btn-primary" x-text="$store.ui.modalData?.id ? $store.i18n.t('common.save') : $store.i18n.t('common.create')">Guardar</button>
                </div>
            </form>
        </div>
    </div>
</div>
</template>