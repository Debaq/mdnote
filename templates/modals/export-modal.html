<!-- Export Modal -->
<div class="legacy-modal" :class="{ 'active': $store.ui.modals.export }">
    <div class="legacy-modal-content">
        <div class="legacy-modal-header">
            <h2 x-text="$store.i18n.t('modals.export.title')">Exportar Proyecto</h2>
            <button class="btn-close" @click="$store.ui.closeModal('export')">
                <i data-lucide="x" width="20" height="20"></i>
            </button>
        </div>
        <div class="modal-body" x-data="{
            get hasApiKeys() {
                const apiKeys = $store.project.apiKeys || {};
                // Nuevo formato: { text: { provider: [...] }, image: { provider: [...] } }
                if (apiKeys.text || apiKeys.image) {
                    const hasTextKeys = apiKeys.text && Object.values(apiKeys.text).some(arr => Array.isArray(arr) && arr.length > 0);
                    const hasImageKeys = apiKeys.image && Object.values(apiKeys.image).some(arr => Array.isArray(arr) && arr.length > 0);
                    return hasTextKeys || hasImageKeys;
                }
                // Formato antiguo (por compatibilidad): { provider: 'key' }
                return Object.keys(apiKeys).length > 0 && Object.values(apiKeys).some(v => typeof v === 'string' && v.trim().length > 0);
            },
            get encryptApiKeys() {
                return this.hasApiKeys ? true : this._encryptApiKeys;
            },
            set encryptApiKeys(value) {
                this._encryptApiKeys = value;
            },
            _encryptApiKeys: false,
            encryptAll: false,
            get showPassword() {
                return this.encryptApiKeys || this.encryptAll;
            },
            getEncryptionSettings() {
                return {
                    encryptApiKeys: this.encryptApiKeys,
                    encryptAll: this.encryptAll
                };
            }
        }" x-init="if(hasApiKeys) { _encryptApiKeys = true; }">
            <p x-text="$store.i18n.t('modals.export.description')">Descarga tu proyecto como archivo PLUMA (*.pluma)</p>

            <div style="margin-top: 20px; padding: 16px; background: var(--bg-tertiary); border-radius: 8px;">
                <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px;">
                    Proyecto: <strong x-text="$store.project.projectInfo.title"></strong>
                </p>
                <p style="font-size: 13px; color: var(--text-secondary);">
                    <span x-text="$store.i18n.t('modals.export.formatWithImages')">Formato: PLUMA con imágenes</span>
                </p>
            </div>

            <!-- Opciones de Encriptación -->
            <div style="margin-top: 20px; padding: 16px; border: 1px solid var(--border); border-radius: 8px;">
                <h3 style="font-size: 14px; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                    <i data-lucide="lock" width="16" height="16"></i>
                    <span x-text="hasApiKeys ? $store.i18n.t('modals.export.securityRequired') : $store.i18n.t('modals.export.securityOptional')">Seguridad</span>
                </h3>

                <!-- Advertencia de API keys -->
                <template x-if="hasApiKeys">
                    <div style="margin-bottom: 16px; padding: 12px; background: color-mix(in srgb, var(--warning) 15%, transparent); border: 1px solid var(--warning); border-radius: 6px;">
                        <div style="display: flex; align-items: start; gap: 10px;">
                            <i data-lucide="alert-triangle" width="16" height="16" style="color: var(--warning); flex-shrink: 0; margin-top: 2px;"></i>
                            <p style="margin: 0; color: var(--text-primary); font-size: 13px; line-height: 1.4;" x-text="$store.i18n.t('modals.export.apiKeysWarning')">
                                Este proyecto contiene API keys. Por seguridad, es obligatorio encriptarlas...
                            </p>
                        </div>
                    </div>
                </template>

                <!-- Solo mostrar opción de encriptar API keys si las hay -->
                <template x-if="hasApiKeys">
                    <div class="form-group" style="margin-bottom: 12px;">
                        <label class="checkbox-label">
                            <input
                                type="checkbox"
                                :checked="encryptApiKeys"
                                :disabled="hasApiKeys"
                                @change="_encryptApiKeys = $event.target.checked"
                            >
                            <span x-text="$store.i18n.t('modals.export.encryptApiKeysRequired')">Encriptar API keys (obligatorio)</span>
                        </label>
                        <p class="hint" style="margin-left: 24px;" x-text="$store.i18n.t('modals.export.apiKeysAutoEncrypt')">Las API keys detectadas serán encriptadas automáticamente</p>
                    </div>
                </template>

                <div class="form-group">
                    <label class="checkbox-label">
                        <input
                            type="checkbox"
                            x-model="encryptAll"
                            @change="if(encryptAll && !hasApiKeys) { _encryptApiKeys = false; }"
                        >
                        <span x-text="$store.i18n.t('modals.export.encryptAll')">Encriptar proyecto completo</span>
                    </label>
                    <p class="hint" style="margin-left: 24px;" x-text="$store.i18n.t('modals.export.encryptAllHint')">Máxima privacidad - encripta todo el contenido (incluye las API keys)</p>
                </div>

                <!-- Campos de contraseña -->
                <template x-if="showPassword">
                    <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border);">
                        <div class="form-group">
                            <label x-text="$store.i18n.t('modals.export.password')">Contraseña de encriptación</label>
                            <input
                                type="password"
                                name="exportPassword"
                                :placeholder="$store.i18n.t('modals.export.passwordPlaceholder')"
                                style="width: 100%;"
                                minlength="12"
                                required
                            >
                            <p class="hint" x-text="$store.i18n.t('modals.export.passwordHint')">Usa una contraseña fuerte. Si la olvidas, no podrás recuperar los datos.</p>
                        </div>
                        <div class="form-group">
                            <label x-text="$store.i18n.t('modals.export.confirmPassword')">Confirmar contraseña</label>
                            <input
                                type="password"
                                name="exportPasswordConfirm"
                                :placeholder="$store.i18n.t('modals.export.confirmPasswordPlaceholder')"
                                style="width: 100%;"
                                required
                            >
                        </div>
                    </div>
                </template>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-secondary" @click="$store.ui.closeModal('export')" x-text="$store.i18n.t('common.cancel')">Cancelar</button>
            <button class="btn-primary" @click="
                (async function() {
                    const modalContent = $event.target.closest('.legacy-modal-content');
                    const modalBody = modalContent.querySelector('.modal-body');

                    // Detectar si hay API keys en el proyecto
                    const apiKeys = $store.project.apiKeys || {};
                    let hasApiKeys = false;
                    // Nuevo formato: { text: { provider: [...] }, image: { provider: [...] } }
                    if (apiKeys.text || apiKeys.image) {
                        const hasTextKeys = apiKeys.text && Object.values(apiKeys.text).some(arr => Array.isArray(arr) && arr.length > 0);
                        const hasImageKeys = apiKeys.image && Object.values(apiKeys.image).some(arr => Array.isArray(arr) && arr.length > 0);
                        hasApiKeys = hasTextKeys || hasImageKeys;
                    } else {
                        // Formato antiguo (por compatibilidad): { provider: 'key' }
                        hasApiKeys = Object.keys(apiKeys).length > 0 && Object.values(apiKeys).some(v => typeof v === 'string' && v.trim().length > 0);
                    }

                    // Obtener valores de encriptación
                    const encryptAllCheckbox = modalBody.querySelector('input[x-model=&quot;encryptAll&quot;]');
                    const encryptAll = encryptAllCheckbox?.checked || false;

                    // Si hay API keys, siempre encriptarlas. Si no, verificar el checkbox
                    const encryptApiKeysCheckbox = modalBody.querySelector('input[type=&quot;checkbox&quot;]:not([x-model])');
                    const encryptApiKeys = hasApiKeys ? true : (encryptApiKeysCheckbox?.checked || false);

                    const passwordField = modalBody.querySelector('[name=exportPassword]');
                    const passwordConfirmField = modalBody.querySelector('[name=exportPasswordConfirm]');

                    let password = null;

                    // Validar contraseña si se seleccionó encriptación
                    if (encryptApiKeys || encryptAll) {
                        if (!passwordField || !passwordField.value) {
                            $store.ui.error('Error', $store.i18n.t('modals.export.errors.passwordRequired'));
                            return;
                        }

                        password = passwordField.value;
                        const passwordConfirm = passwordConfirmField?.value || '';

                        if (password.length < 12) {
                            $store.ui.error('Error', $store.i18n.t('modals.export.errors.passwordTooShort'));
                            return;
                        }

                        if (password !== passwordConfirm) {
                            $store.ui.error('Error', $store.i18n.t('modals.export.errors.passwordMismatch'));
                            return;
                        }
                    }

                    try {
                        const options = {
                            includeAssets: true,  // Siempre incluir imágenes
                            password: password,
                            encryptAll: encryptAll
                        };

                        const success = await window.storageManager.exportProject(
                            $store.project.exportProject(),
                            options
                        );

                        if (success) {
                            $store.ui.success($store.i18n.t('modals.export.success'), $store.i18n.t('modals.export.successDetails'));
                            $store.ui.closeModal('export');
                        } else {
                            $store.ui.error('Error', $store.i18n.t('modals.export.errors.exportFailed'));
                        }
                    } catch (error) {
                        console.error('Error exportando:', error);
                        $store.ui.error('Error', error.message || $store.i18n.t('modals.export.errors.exportFailed'));
                    }
                })();
            ">
                <i data-lucide="download" width="16" height="16"></i>
                <span x-text="$store.i18n.t('modals.export.download')">Descargar</span>
            </button>
        </div>
    </div>
</div>
