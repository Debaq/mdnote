<!-- AI Assistant View -->
<div x-show="$store.ui.currentView === 'aiAssistant'" class="view" x-data="aiAssistantView()">
    <div class="view-header">
        <h1 x-text="$store.i18n.t('ai.title')">üí¨ Asistente IA - Brainstorming</h1>
        <p class="subtitle" x-text="$store.i18n.t('ai.subtitle')">Conversa con la IA sobre tu historia: genera ideas, analiza estructura, desarrolla personajes, expande worldbuilding. <strong>Para escribir cap√≠tulos directamente,</strong> usa el Editor con el toolbar de IA ‚òÅÔ∏è</p>
    </div>

    <div class="view-content" style="display: flex; flex-direction: column; gap: 16px; max-width: 1200px; margin: 0 auto;">

        <!-- Configuration Panel -->
        <div class="card" style="padding: 16px;">
            <div style="display: flex; gap: 16px; align-items: flex-start; flex-wrap: wrap;">

                <!-- Provider Selection -->
                <div style="flex: 1; min-width: 200px;">
                    <label class="form-label" style="margin-bottom: 8px; display: block;">
                        <i data-lucide="cpu" width="16" height="16" style="vertical-align: middle;"></i>
                        <span x-text="$store.i18n.t('ai.provider')">Proveedor de IA</span>
                    </label>
                    <template x-if="providersWithApiKey.length > 0">
                        <select x-model="selectedProvider" @change="onProviderChange()" class="p-md bg-primary border rounded-lg" style="width: 100%;">
                            <template x-for="status in providersWithApiKey" :key="status.id">
                                <option :value="status.id" x-text="status.name"></option>
                            </template>
                        </select>
                    </template>
                    <template x-if="providersWithApiKey.length === 0">
                        <div style="padding: 12px; background: var(--warning-color); color: var(--warning-text); border-radius: 6px; font-size: 13px;">
                            <i data-lucide="alert-circle" width="16" height="16" style="vertical-align: middle;"></i>
                            <span x-text="$store.i18n.t('ai.noProvidersConfigured')">No hay proveedores con API key configurada. Ve a <strong>Configuraci√≥n IA</strong> para agregar una.</span>
                        </div>
                    </template>
                    <p class="form-hint" style="margin-top: 4px; font-size: 12px; color: var(--text-secondary);" x-show="providersWithApiKey.length > 0">
                        <span x-show="currentProviderInfo">
                            <span x-text="currentProviderInfo?.freeTier"></span> -
                            <span x-text="currentProviderInfo?.pricing"></span>
                        </span>
                    </p>
                </div>

                <!-- Model Selection -->
                <div style="flex: 1; min-width: 200px;">
                    <label class="form-label" style="margin-bottom: 8px; display: block;">
                        <i data-lucide="brain" width="16" height="16" style="vertical-align: middle;"></i>
                        <span x-text="$store.i18n.t('ai.model')">Modelo</span>
                    </label>
                    <select x-model="selectedModel" class="p-md bg-primary border rounded-lg" style="width: 100%;">
                        <template x-for="model in availableModels" :key="model">
                            <option :value="model" x-text="model"></option>
                        </template>
                    </select>
                </div>

                <!-- Mode Selection -->
                <div style="flex: 1; min-width: 200px;">
                    <label class="form-label" style="margin-bottom: 8px; display: block;">
                        <i data-lucide="wand-2" width="16" height="16" style="vertical-align: middle;"></i>
                        <span x-text="$store.i18n.t('ai.assistanceMode')">Modo de Asistencia</span>
                    </label>
                    <select x-model="selectedMode" class="p-md bg-primary border rounded-lg" style="width: 100%;">
                        <template x-for="mode in assistantModes" :key="mode.id">
                            <option :value="mode.id" x-text="mode.icon + ' ' + mode.name"></option>
                        </template>
                    </select>
                    <p class="form-hint" style="margin-top: 4px; font-size: 12px; color: var(--text-secondary);" x-text="currentModeDescription"></p>
                </div>

            </div>

            <!-- Context Panel (Collapsible) -->
            <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-color);">
                <button @click="showContext = !showContext" class="btn-secondary" style="width: 100%; display: flex; align-items: center; justify-content: space-between;">
                    <span style="display: flex; align-items: center; gap: 8px;">
                        <i data-lucide="database" width="16" height="16"></i>
                        <span x-text="$store.i18n.t('ai.projectContext')">Contexto del Proyecto</span>
                    </span>
                    <i :data-lucide="showContext ? 'chevron-up' : 'chevron-down'" width="16" height="16"></i>
                </button>

                <div x-show="showContext" x-collapse style="margin-top: 12px; padding: 12px; background: var(--bg-tertiary); border-radius: 8px; font-size: 13px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                        <div>
                            <strong x-text="$store.i18n.t('ai.project') + ':'">üìñ Proyecto:</strong> <span x-text="contextInfo.projectTitle"></span><br>
                            <strong x-text="$store.i18n.t('ai.genre') + ':'">üìö G√©nero:</strong> <span x-text="contextInfo.genre || $store.i18n.t('ai.notSpecified')"></span>
                        </div>
                        <div>
                            <strong x-text="$store.i18n.t('ai.characters') + ':'">üë• Personajes:</strong> <span x-text="contextInfo.charactersCount"></span><br>
                            <strong x-text="$store.i18n.t('ai.locations') + ':'">üìç Locaciones:</strong> <span x-text="contextInfo.locationsCount"></span>
                        </div>
                        <div>
                            <strong x-text="$store.i18n.t('ai.scenes') + ':'">üé¨ Escenas:</strong> <span x-text="contextInfo.scenesCount"></span><br>
                            <strong x-text="$store.i18n.t('ai.lore') + ':'">üìú Lore:</strong> <span x-text="contextInfo.loreCount"></span>
                        </div>
                        <div>
                            <strong x-text="$store.i18n.t('ai.chapters') + ':'">üìñ Cap√≠tulos:</strong> <span x-text="contextInfo.chaptersCount"></span><br>
                            <strong x-text="$store.i18n.t('ai.words') + ':'">üìù Palabras:</strong> <span x-text="contextInfo.totalWords"></span>
                        </div>
                    </div>
                    <p style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-color); color: var(--text-secondary);">
                        <i data-lucide="info" width="14" height="14" style="vertical-align: middle;"></i>
                        <span x-text="$store.i18n.t('ai.contextInfo')">Este contexto se env√≠a autom√°ticamente con cada consulta para que la IA entienda tu historia.</span>
                    </p>
                </div>
            </div>
        </div>

        <!-- Chat Area -->
        <div class="card" style="flex: 1; display: flex; flex-direction: column; height: 500px; padding: 0;">

            <!-- Messages Container -->
            <div x-ref="messagesContainer" class="messages-container" style="flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 12px;">

                <!-- Empty State -->
                <template x-if="messages.length === 0">
                    <div class="empty-state" style="margin: auto; text-align: center;">
                        <i data-lucide="message-circle" width="64" height="64"></i>
                        <h3 x-text="$store.i18n.t('ai.emptyState.title')">üí¨ Asistente de Brainstorming Creativo</h3>
                        <p style="max-width: 600px; margin: 0 auto 20px; color: var(--text-secondary); line-height: 1.6;" x-html="$store.i18n.t('ai.emptyState.description')">
                            <strong>Tengo memoria conversacional:</strong> Recuerdo todo lo que hablamos en esta sesi√≥n.<br>
                            Puedo ayudarte a generar ideas, analizar estructura narrativa, desarrollar personajes, expandir worldbuilding y dar feedback creativo.
                        </p>
                        <div style="background: var(--bg-tertiary); padding: 15px; border-radius: 8px; max-width: 550px; margin: 0 auto; border-left: 4px solid var(--accent);">
                            <p style="margin: 0; font-size: 13px; color: var(--text-secondary); text-align: left;" x-html="$store.i18n.t('ai.emptyState.tip')">
                                <strong>üí° Tip:</strong> Este espacio es para <strong>planificar y explorar ideas</strong>.<br>
                                Para <strong>escribir cap√≠tulos directamente</strong>, ve al <strong>Editor</strong> y usa el <strong>toolbar de IA flotante ‚òÅÔ∏è</strong> que aparece al seleccionar texto.
                            </p>
                        </div>
                    </div>
                </template>

                <!-- Messages -->
                <template x-for="message in messages" :key="message.id">
                    <div class="message" :class="'message-' + message.role" style="display: flex; gap: 12px; align-items: flex-start;">

                        <!-- Avatar -->
                        <div class="message-avatar" style="flex-shrink: 0; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px;"
                             :style="message.role === 'user' ? 'background: var(--primary-color); color: white;' : 'background: var(--bg-tertiary); color: var(--text-primary);'">
                            <span x-text="message.role === 'user' ? 'üë§' : 'ü§ñ'"></span>
                        </div>

                        <!-- Message Content -->
                        <div class="message-content" style="flex: 1; padding: 12px 16px; border-radius: 12px; background: var(--bg-tertiary);"
                             :style="message.role === 'user' ? 'background: var(--primary-color); color: white;' : ''">

                            <!-- User Message -->
                            <template x-if="message.role === 'user'">
                                <div>
                                    <div style="font-size: 11px; opacity: 0.8; margin-bottom: 4px;">
                                        <span x-text="getModeIcon(message.metadata?.mode)"></span>
                                        <span x-text="getModeName(message.metadata?.mode)"></span>
                                    </div>
                                    <div x-text="message.content" style="white-space: pre-wrap;"></div>
                                </div>
                            </template>

                            <!-- Assistant Message -->
                            <template x-if="message.role === 'assistant'">
                                <div>
                                    <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 8px;">
                                        <strong><span x-text="message.metadata?.provider"></span> ¬∑ <span x-text="message.metadata?.model"></span></strong>
                                    </div>
                                    <div x-html="formatMarkdown(message.content)" style="white-space: pre-wrap; line-height: 1.6;"></div>

                                    <!-- Action Buttons -->
                                    <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-color); display: flex; gap: 8px;">
                                        <button @click="copyToClipboard(message.content)" class="btn-icon" :title="$store.i18n.t('ai.copyResponse')">
                                            <i data-lucide="copy" width="16" height="16"></i>
                                        </button>
                                        <button @click="insertIntoEditor(message.content)" class="btn-icon" :title="$store.i18n.t('ai.insertInEditor')" x-show="$store.project.activeChapterId">
                                            <i data-lucide="file-plus" width="16" height="16"></i>
                                        </button>
                                    </div>
                                </div>
                            </template>
                        </div>

                        <!-- Timestamp -->
                        <div class="message-timestamp" style="flex-shrink: 0; font-size: 11px; color: var(--text-secondary); margin-top: 8px;">
                            <span x-text="formatTime(message.timestamp)"></span>
                        </div>
                    </div>
                </template>

                <!-- Processing Indicator -->
                <template x-if="isProcessing">
                    <div class="message message-assistant" style="display: flex; gap: 12px; align-items: flex-start;">
                        <div class="message-avatar" style="flex-shrink: 0; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; background: var(--bg-tertiary);">
                            ü§ñ
                        </div>
                        <div class="message-content" style="flex: 1; padding: 12px 16px; border-radius: 12px; background: var(--bg-tertiary);">
                            <div class="typing-indicator">
                                <span></span><span></span><span></span>
                            </div>
                        </div>
                    </div>
                </template>

            </div>

            <!-- Input Area -->
            <div style="padding: 16px; border-top: 1px solid var(--border-color); background: var(--bg-secondary);">
                <form @submit.prevent="sendMessage()" style="display: flex; gap: 12px; align-items: flex-end;">
                    <div style="flex: 1;">
                        <textarea
                            x-model="userInput"
                            :placeholder="$store.i18n.t('ai.inputPlaceholder')"
                            rows="3"
                            style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-primary); color: var(--text-primary); resize: vertical; font-family: inherit;"
                            @keydown.ctrl.enter="sendMessage()"
                            :disabled="isProcessing"
                        ></textarea>
                        <p class="form-hint" style="margin-top: 4px; font-size: 11px; color: var(--text-secondary);" x-text="$store.i18n.t('ai.pressCtrlEnter')">
                            Presiona Ctrl+Enter para enviar
                        </p>
                    </div>
                    <button
                        type="submit"
                        class="btn-primary"
                        :disabled="!userInput.trim() || isProcessing || !isConfigured"
                        style="padding: 12px 24px; height: fit-content;">
                        <i data-lucide="send" width="16" height="16"></i>
                        <span x-text="isProcessing ? $store.i18n.t('ai.processing') : $store.i18n.t('ai.send')"></span>
                    </button>
                </form>

                <!-- Warning if not configured -->
                <div x-show="!isConfigured" style="margin-top: 12px; padding: 12px; background: var(--warning-color); color: var(--warning-text); border-radius: 8px; font-size: 13px;">
                    <i data-lucide="alert-triangle" width="16" height="16" style="vertical-align: middle;"></i>
                    <span x-html="$store.i18n.t('ai.configRequired')"><strong>Configuraci√≥n requerida:</strong> Por favor configura una API key en Ajustes ‚Üí Configuraci√≥n IA para poder usar el asistente.</span>
                </div>
            </div>

        </div>

        <!-- Quick Actions -->
        <div class="card" style="padding: 16px;">
            <h3 style="font-size: 14px; font-weight: 600; margin-bottom: 12px; color: var(--text-secondary);">
                <i data-lucide="zap" width="16" height="16" style="vertical-align: middle;"></i>
                <span x-text="$store.i18n.t('ai.quickActions.title')">Consultas R√°pidas de Brainstorming</span>
            </h3>
            <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                <button @click="quickAction('suggest')" class="btn-secondary" style="flex: 0 0 auto;">
                    <span x-text="$store.i18n.t('ai.quickActions.plotIdeas')">üí° Ideas para la trama</span>
                </button>
                <button @click="quickAction('analyze')" class="btn-secondary" style="flex: 0 0 auto;">
                    <span x-text="$store.i18n.t('ai.quickActions.analyzeStructure')">üîç Analizar estructura</span>
                </button>
                <button @click="quickAction('worldbuild')" class="btn-secondary" style="flex: 0 0 auto;">
                    <span x-text="$store.i18n.t('ai.quickActions.worldbuilding')">üåç Worldbuilding</span>
                </button>
                <button @click="quickAction('characterize')" class="btn-secondary" style="flex: 0 0 auto;">
                    <span x-text="$store.i18n.t('ai.quickActions.characterDevelopment')">üé≠ Desarrollo de personajes</span>
                </button>
                <button @click="quickAction('dialogue')" class="btn-secondary" style="flex: 0 0 auto;">
                    <span x-text="$store.i18n.t('ai.quickActions.dialogueTips')">üí¨ Consejos de di√°logos</span>
                </button>
                <button @click="quickAction('continue')" class="btn-secondary" style="flex: 0 0 auto;">
                    <span x-text="$store.i18n.t('ai.quickActions.nextScenes')">üìñ Pr√≥ximas escenas</span>
                </button>
                <button @click="clearChat()" class="btn-secondary" style="flex: 0 0 auto; margin-left: auto; color: var(--danger-color);">
                    <i data-lucide="trash-2" width="16" height="16"></i>
                    <span x-text="$store.i18n.t('ai.clearChat')">Limpiar chat</span>
                </button>
            </div>
        </div>

    </div>
</div>

<style>
/* Typing indicator animation */
.typing-indicator {
    display: flex;
    gap: 4px;
    padding: 8px 0;
}

.typing-indicator span {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--text-secondary);
    animation: typing 1.4s infinite;
}

.typing-indicator span:nth-child(2) {
    animation-delay: 0.2s;
}

.typing-indicator span:nth-child(3) {
    animation-delay: 0.4s;
}

@keyframes typing {
    0%, 60%, 100% {
        opacity: 0.3;
        transform: scale(0.8);
    }
    30% {
        opacity: 1;
        transform: scale(1);
    }
}

/* Message animations */
.message {
    animation: fadeInUp 0.3s ease;
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Scrollbar styling */
.messages-container::-webkit-scrollbar {
    width: 8px;
}

.messages-container::-webkit-scrollbar-track {
    background: var(--bg-primary);
}

.messages-container::-webkit-scrollbar-thumb {
    background: var(--border-color);
    border-radius: 4px;
}

.messages-container::-webkit-scrollbar-thumb:hover {
    background: var(--text-secondary);
}
</style>
