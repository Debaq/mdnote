<div class="view" x-show="$store.ui.currentView === 'publishing'" x-data="publishingComponent" x-cloak>
    <div class="view-header">
        <div>
            <h1 x-text="$store.i18n.t('publishing.title')">Publicación</h1>
            <p class="subtitle" x-text="$store.i18n.t('publishing.subtitle')">Prepara tu libro para publicar</p>
        </div>
    </div>

    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: var(--spacing-xl); margin-bottom: var(--spacing-xl);">
        <!-- LEFT COLUMN -->
        <div style="display: flex; flex-direction: column; gap: var(--spacing-xl);">

            <!-- 1. PORTADA -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title" x-text="$store.i18n.t('publishing.cover.title')">Portada</h2>
                </div>
                <div style="display: flex; gap: var(--spacing-xl); align-items: start;">
                    <!-- Cover Preview -->
                    <div style="flex-shrink: 0;">
                        <div x-show="!publishingCoverImage"
                             style="width: 200px; height: 300px; background: var(--bg-tertiary); border: 2px dashed var(--border); border-radius: 6px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: var(--spacing-md);">
                            <i data-lucide="image" width="48" height="48" style="color: var(--text-tertiary);"></i>
                            <span style="font-size: var(--font-size-sm); color: var(--text-tertiary);" x-text="$store.i18n.t('publishing.cover.noCover')">Sin portada</span>
                        </div>
                        <div x-show="publishingCoverImage"
                             style="width: 200px; height: 300px; background: var(--bg-tertiary); border-radius: 6px; overflow: hidden; border: 1px solid var(--border);">
                            <img :src="publishingCoverImage" alt="Cover" style="width: 100%; height: 100%; object-fit: cover;">
                        </div>
                    </div>

                    <!-- Cover Actions -->
                    <div style="flex: 1;">
                        <p style="font-size: var(--font-size-sm); color: var(--text-secondary); margin-bottom: var(--spacing-md);" x-text="$store.i18n.t('publishing.cover.recommendation')">
                            Recomendado: 1600x2400px (proporción 2:3)
                        </p>
                        <input type="file" id="coverUpload" accept="image/*" style="display: none;"
                               @change="handleCoverUpload($event)">
                        <div style="display: flex; gap: var(--spacing-sm);">
                            <button x-show="!publishingCoverImage" class="btn-primary" @click="$el.parentElement.querySelector('#coverUpload').click()">
                                <i data-lucide="upload" width="16" height="16"></i>
                                <span x-text="$store.i18n.t('publishing.cover.upload')">Subir Portada</span>
                            </button>
                            <button x-show="publishingCoverImage" class="btn-secondary" @click="$el.parentElement.querySelector('#coverUpload').click()">
                                <i data-lucide="refresh-cw" width="16" height="16"></i>
                                <span x-text="$store.i18n.t('publishing.cover.change')">Cambiar</span>
                            </button>
                            <button x-show="publishingCoverImage" class="btn-secondary" @click="publishingCoverImage = null">
                                <i data-lucide="trash-2" width="16" height="16"></i>
                                <span x-text="$store.i18n.t('publishing.cover.remove')">Quitar</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. METADATOS -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title" x-text="$store.i18n.t('publishing.metadata.title')">Información del Libro</h2>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-lg);">
                    <div class="form-group">
                        <label x-text="$store.i18n.t('publishing.metadata.bookTitle')">Título del Libro</label>
                        <input type="text" x-model="publishingBookTitle" :placeholder="$store.i18n.t('publishing.metadata.bookTitlePlaceholder')">
                    </div>
                    <div class="form-group">
                        <label x-text="$store.i18n.t('publishing.metadata.subtitle')">Subtítulo</label>
                        <input type="text" x-model="publishingSubtitle" :placeholder="$store.i18n.t('publishing.metadata.subtitlePlaceholder')">
                    </div>
                    <div class="form-group">
                        <label x-text="$store.i18n.t('publishing.metadata.author')">Autor</label>
                        <input type="text" x-model="publishingAuthor" :placeholder="$store.i18n.t('publishing.metadata.authorPlaceholder')">
                    </div>
                    <div class="form-group">
                        <label x-text="$store.i18n.t('publishing.metadata.isbn')">ISBN</label>
                        <input type="text" x-model="publishingISBN" :placeholder="$store.i18n.t('publishing.metadata.isbnPlaceholder')">
                    </div>
                    <div class="form-group">
                        <label x-text="$store.i18n.t('publishing.metadata.publisher')">Editorial</label>
                        <input type="text" x-model="publishingPublisher" :placeholder="$store.i18n.t('publishing.metadata.publisherPlaceholder')">
                    </div>
                    <div class="form-group">
                        <label x-text="$store.i18n.t('publishing.metadata.year')">Año</label>
                        <input type="text" x-model="publishingYear" :placeholder="$store.i18n.t('publishing.metadata.yearPlaceholder')">
                    </div>
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label x-text="$store.i18n.t('publishing.metadata.description')">Descripción</label>
                        <textarea x-model="publishingDescription" :placeholder="$store.i18n.t('publishing.metadata.descriptionPlaceholder')" rows="4"></textarea>
                    </div>
                    <div class="form-group">
                        <label x-text="$store.i18n.t('publishing.metadata.genre')">Género</label>
                        <input type="text" x-model="publishingGenre" :placeholder="$store.i18n.t('publishing.metadata.genrePlaceholder')">
                    </div>
                    <div class="form-group">
                        <label x-text="$store.i18n.t('publishing.metadata.language')">Idioma</label>
                        <input type="text" x-model="publishingLanguage" value="Español">
                    </div>
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label x-text="$store.i18n.t('publishing.metadata.copyright')">Copyright</label>
                        <input type="text" x-model="publishingCopyright" :placeholder="$store.i18n.t('publishing.metadata.copyrightPlaceholder')">
                    </div>
                </div>
            </div>

            <!-- 3. SELECCIÓN DE CAPÍTULOS -->
            <div class="card">
                <div class="card-header">
                    <div>
                        <h2 class="card-title" x-text="$store.i18n.t('publishing.chapters.title')">Selección de Capítulos</h2>
                        <p style="font-size: var(--font-size-sm); color: var(--text-secondary); margin-top: var(--spacing-xs);">
                            <span x-text="$store.i18n.t('publishing.chapters.selected', {count: publishingSelectedChapters.length})"></span> ·
                            <span x-text="$store.i18n.t('publishing.chapters.totalWords', {count: publishingTotalWords})"></span>
                        </p>
                    </div>
                    <div class="card-actions">
                        <button class="btn-secondary btn-sm" @click="publishingSelectAllChapters()">
                            <span x-text="$store.i18n.t('publishing.chapters.selectAll')">Seleccionar Todos</span>
                        </button>
                        <button class="btn-secondary btn-sm" @click="publishingDeselectAllChapters()">
                            <span x-text="$store.i18n.t('publishing.chapters.deselectAll')">Deseleccionar Todos</span>
                        </button>
                    </div>
                </div>

                <!-- Lista de Capítulos -->
                <div x-show="$store.project.chapters.length === 0" class="empty-state" style="padding: var(--spacing-xl);">
                    <i data-lucide="book-open" width="48" height="48"></i>
                    <p x-text="$store.i18n.t('publishing.chapters.noChapters')">No hay capítulos</p>
                </div>

                <div x-show="$store.project.chapters.length > 0" style="display: flex; flex-direction: column; gap: var(--spacing-sm);">
                    <template x-for="chapter in $store.project.chapters" :key="chapter.id">
                        <div class="chapter-selector-item"
                             style="display: flex; align-items: center; gap: var(--spacing-md); padding: var(--spacing-md); background: var(--bg-tertiary); border-radius: 6px; cursor: pointer; border: 2px solid transparent;"
                             :style="publishingSelectedChapters.includes(chapter.id) ? 'border-color: var(--accent);' : ''"
                             @click="toggleChapterSelection(chapter.id)">
                            <input type="checkbox" :checked="publishingSelectedChapters.includes(chapter.id)"
                                   @click.stop="toggleChapterSelection(chapter.id)"
                                   style="width: 18px; height: 18px; cursor: pointer;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; font-size: var(--font-size-sm);">
                                    <span style="color: var(--text-tertiary);" x-text="'Cap. ' + chapter.number"></span>
                                    <span style="margin-left: var(--spacing-sm);" x-text="chapter.title"></span>
                                </div>
                                <div style="font-size: var(--font-size-xs); color: var(--text-secondary); margin-top: 2px;">
                                    <span x-text="(chapter.content?.length || 0) + ' caracteres'"></span>
                                    <span style="margin: 0 var(--spacing-sm);">·</span>
                                    <span x-text="Math.round((chapter.content?.split(' ').length || 0)) + ' palabras'"></span>
                                </div>
                            </div>
                            <i data-lucide="check" width="20" height="20"
                               x-show="publishingSelectedChapters.includes(chapter.id)"
                               style="color: var(--accent);"></i>
                        </div>
                    </template>
                </div>
            </div>
        </div>

        <!-- RIGHT COLUMN - Format & Export -->
        <div style="display: flex; flex-direction: column; gap: var(--spacing-xl); position: sticky; top: var(--spacing-xl);">

            <!-- 4. FORMATO -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title" x-text="$store.i18n.t('publishing.format.title')">Formato</h2>
                </div>

                <!-- Preset Templates -->
                <div class="form-group">
                    <label x-text="$store.i18n.t('publishing.presets.title')">Plantillas</label>
                    <select x-model="publishingPreset" @change="applyPreset()">
                        <option value="custom" x-text="$store.i18n.t('publishing.presets.custom')">Personalizado</option>
                        <option value="amazonKDP" x-text="$store.i18n.t('publishing.presets.amazonKDP')">Amazon KDP</option>
                        <option value="createspace" x-text="$store.i18n.t('publishing.presets.createspace')">CreateSpace</option>
                        <option value="ingramspark" x-text="$store.i18n.t('publishing.presets.ingramspark')">IngramSpark</option>
                    </select>
                </div>

                <div class="form-divider"></div>

                <div class="form-group">
                    <label x-text="$store.i18n.t('publishing.format.pageSize')">Tamaño de Página</label>
                    <select x-model="publishingPageSize">
                        <option value="6x9" x-text="$store.i18n.t('publishing.format.pageSize6x9')">6" x 9"</option>
                        <option value="A4" x-text="$store.i18n.t('publishing.format.pageSizeA4')">A4</option>
                        <option value="A5" x-text="$store.i18n.t('publishing.format.pageSizeA5')">A5</option>
                        <option value="letter" x-text="$store.i18n.t('publishing.format.pageSizeLetter')">Carta</option>
                    </select>
                </div>

                <div class="form-group">
                    <label x-text="$store.i18n.t('publishing.format.margins')">Márgenes</label>
                    <select x-model="publishingMargins">
                        <option value="normal" x-text="$store.i18n.t('publishing.format.marginsNormal')">Normal</option>
                        <option value="narrow" x-text="$store.i18n.t('publishing.format.marginsNarrow')">Estrecho</option>
                        <option value="wide" x-text="$store.i18n.t('publishing.format.marginsWide')">Ancho</option>
                    </select>
                </div>

                <div class="form-group">
                    <label x-text="$store.i18n.t('publishing.format.fontFamily')">Fuente</label>
                    <select x-model="publishingFontFamily">
                        <option value="serif">Serif (Times, Georgia)</option>
                        <option value="sans">Sans-serif (Arial, Helvetica)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label x-text="$store.i18n.t('publishing.format.fontSize')">Tamaño de Fuente</label>
                    <select x-model="publishingFontSize">
                        <option value="10">10pt</option>
                        <option value="11">11pt</option>
                        <option value="12">12pt</option>
                        <option value="13">13pt</option>
                        <option value="14">14pt</option>
                    </select>
                </div>

                <div class="form-divider"></div>

                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" x-model="publishingIncludePageNumbers">
                        <span x-text="$store.i18n.t('publishing.format.includePageNumbers')">Incluir números de página</span>
                    </label>
                </div>

                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" x-model="publishingIncludeToC">
                        <span x-text="$store.i18n.t('publishing.format.includeTableOfContents')">Incluir tabla de contenidos</span>
                    </label>
                </div>
            </div>

            <!-- 5. EXPORTAR -->
            <div class="card" style="background: var(--accent); color: white;">
                <div style="margin-bottom: var(--spacing-lg);">
                    <h2 style="font-size: var(--font-size-lg); font-weight: 600; margin-bottom: var(--spacing-sm);"
                        x-text="$store.i18n.t('publishing.export.title')">Exportar</h2>

                    <!-- Validation Status -->
                    <div x-show="!publishingIsValid()" style="font-size: var(--font-size-sm); opacity: 0.9;">
                        <span x-text="$store.i18n.t('publishing.validation.warnings')">Advertencias:</span>
                        <ul style="margin: var(--spacing-sm) 0 0 var(--spacing-lg); list-style: disc;">
                            <li x-show="!publishingCoverImage" x-text="$store.i18n.t('publishing.validation.noCover')"></li>
                            <li x-show="!publishingBookTitle" x-text="$store.i18n.t('publishing.validation.noTitle')"></li>
                            <li x-show="!publishingAuthor" x-text="$store.i18n.t('publishing.validation.noAuthor')"></li>
                            <li x-show="publishingSelectedChapters.length === 0" x-text="$store.i18n.t('publishing.validation.noChapters')"></li>
                        </ul>
                    </div>
                    <div x-show="publishingIsValid()" style="font-size: var(--font-size-sm); opacity: 0.9; display: flex; align-items: center; gap: var(--spacing-sm);">
                        <i data-lucide="check-circle" width="16" height="16"></i>
                        <span x-text="$store.i18n.t('publishing.validation.ready')">Listo para exportar</span>
                    </div>
                </div>

                <div style="display: flex; flex-direction: column; gap: var(--spacing-sm);">
                    <button @click="exportToPDF()"
                            :disabled="!publishingIsValid()"
                            style="width: 100%; padding: var(--spacing-lg); background: white; color: var(--accent); border: none; border-radius: 6px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: var(--spacing-md); transition: var(--transition-fast);"
                            :style="!publishingIsValid() ? 'opacity: 0.5; cursor: not-allowed;' : ''"
                            @mouseover="if(publishingIsValid()) $el.style.transform = 'translateY(-2px)'"
                            @mouseout="$el.style.transform = 'translateY(0)'">
                        <i data-lucide="file-text" width="20" height="20"></i>
                        <span x-text="$store.i18n.t('publishing.export.exportPDF')">Exportar a PDF</span>
                    </button>

                    <button @click="exportToDOCX()"
                            :disabled="!publishingIsValid()"
                            style="width: 100%; padding: var(--spacing-lg); background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); border-radius: 6px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: var(--spacing-md); transition: var(--transition-fast);"
                            :style="!publishingIsValid() ? 'opacity: 0.5; cursor: not-allowed;' : ''"
                            @mouseover="if(publishingIsValid()) $el.style.background = 'rgba(255,255,255,0.3)'"
                            @mouseout="$el.style.background = 'rgba(255,255,255,0.2)'">
                        <i data-lucide="file-code" width="20" height="20"></i>
                        <span x-text="$store.i18n.t('publishing.export.exportDOCX')">Exportar a DOCX</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
