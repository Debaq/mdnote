<!-- Editor View -->
<div x-show="$store.ui.currentView === 'editor'"
     class="view"
     style="padding: 0; height: 100%;"
     x-data="editorAlpineComponent()">

    <template x-if="currentChapter">
        <div class="editor-container">
            <!-- Editor Main Area -->
            <div class="editor-main">
                <!-- Track Changes Controls -->
                <div x-data="trackChangesUI()" class="track-changes-controls" x-show="true">
                    <!-- Toggle Modo Edición -->
                    <button
                        type="button"
                        class="track-changes-toggle"
                        :class="{ 'active': editMode }"
                        @click="toggleEditMode()"
                        :title="editMode ? 'Desactivar modo edición (readonly)' : 'Activar modo edición'"
                    >
                        <i :data-lucide="editMode ? 'edit-3' : 'lock'" width="16" height="16"></i>
                    </button>

                    <!-- Toggle Mostrar/Ocultar Colores -->
                    <button
                        type="button"
                        class="track-changes-toggle"
                        :class="{ 'active': showColors }"
                        @click="toggleColors()"
                        :title="showColors ? 'Ocultar colores (temporal)' : 'Mostrar colores'"
                    >
                        <i :data-lucide="showColors ? 'eye' : 'eye-off'" width="16" height="16"></i>
                    </button>

                    <!-- Separador -->
                    <div style="width: 1px; height: 24px; background: var(--border); margin: 0 4px;"></div>

                    <!-- Aceptar Todos (Normalizar + Commit) -->
                    <button
                        type="button"
                        class="accept-all-changes-btn"
                        @click="acceptAllAndCommit()"
                        :disabled="pendingCount === 0"
                        title="Aceptar todos los cambios y crear commit"
                    >
                        <i data-lucide="check-circle" width="16" height="16"></i>
                    </button>

                    <!-- Rechazar Todos -->
                    <button
                        type="button"
                        class="reject-all-changes-btn"
                        @click="rejectAllChanges()"
                        :disabled="pendingCount === 0"
                        title="Rechazar todos los cambios"
                    >
                        <i data-lucide="x-circle" width="16" height="16"></i>
                    </button>

                    <!-- Separador -->
                    <div style="width: 1px; height: 24px; background: var(--border); margin: 0 4px;"></div>

                    <!-- Contador de Cambios -->
                    <div class="changes-count" title="Cambios pendientes">
                        <i data-lucide="list" width="14" height="14"></i>
                        <span class="changes-count-number" x-text="pendingCount"></span>
                    </div>

                    <!-- Leyenda de Colores -->
                    <div style="display: flex; align-items: center; gap: 12px; margin-left: auto; font-size: 11px;">
                        <div style="display: flex; align-items: center; gap: 4px;" title="Texto generado por la IA">
                            <div style="width: 12px; height: 12px; background: #a78bfa; border-radius: 2px;"></div>
                            <span style="color: var(--text-secondary);">IA</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 4px;" title="Texto reemplazado por la IA">
                            <div style="width: 12px; height: 12px; background: #ef4444; border-radius: 2px; text-decoration: line-through;"></div>
                            <span style="color: var(--text-secondary);">Tachado</span>
                        </div>
                    </div>
                </div>

                <!-- Writing Area -->
                <div class="editor-writing-area" style="position: relative;">
                    <!-- RichEditor Container -->
                    <div class="rich-editor-wrapper"></div>
                </div>
            </div>

            <!-- Editor Sidebar -->
            <aside class="editor-sidebar" :class="{ 'collapsed': !$store.ui.editorSidebarOpen }">
                <!-- Chapter Info -->
                <div class="editor-sidebar-section">
                    <h3 x-text="$store.i18n.t('chapters.form.title')"></h3>
                    <input
                        type="text"
                        x-model="currentChapter.title"
                        @input="autoSave()"
                        :placeholder="$store.i18n.t('chapters.form.titlePlaceholder')"
                        style="width: 100%; padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);"
                    >
                    <div style="margin-top: 12px;">
                        <label style="font-size: 12px; color: var(--text-secondary); display: block; margin-bottom: 4px;" x-text="$store.i18n.t('chapters.form.status')"></label>
                        <select
                            x-model="currentChapter.status"
                            @change="autoSave()"
                            style="width: 100%; padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary); cursor: pointer;"
                        >
                            <option value="draft" x-text="$store.i18n.t('chapters.form.statuses.draft')"></option>
                            <option value="review" x-text="$store.i18n.t('chapters.form.statuses.review')"></option>
                            <option value="final" x-text="$store.i18n.t('chapters.form.statuses.final')"></option>
                        </select>
                    </div>
                </div>

                <!-- Characters Context -->
                <div class="editor-sidebar-section">
                    <h3 x-text="$store.i18n.t('sidebar.characters')"></h3>
                    <template x-if="$store.project.characters.length === 0">
                        <p style="font-size: 13px; color: var(--text-tertiary);" x-text="$store.i18n.t('characters.empty')"></p>
                    </template>
                    <template x-if="$store.project.characters.length > 0">
                        <div>
                            <template x-for="character in $store.project.characters.slice(0, 5)" :key="character.id">
                                <div class="editor-context-item">
                                    <div class="editor-context-item-title" x-text="character.name"></div>
                                    <div class="editor-context-item-desc" x-text="$store.i18n.t('characters.form.roles.' + character.role)"></div>
                                </div>
                            </template>
                        </div>
                    </template>
                </div>

                <!-- AI Assistant -->
                <div class="editor-sidebar-section" style="background: var(--bg-tertiary); margin: 0; border-radius: 0;">
                    <h3 style="display: flex; align-items: center; gap: 8px;">
                        <i data-lucide="sparkles" width="16" height="16" style="color: var(--accent);"></i>
                        <span x-text="$store.i18n.t('sidebar.aiAssistant')"></span>
                    </h3>
                    <div class="editor-ai-actions">
                        <button type="button" class="editor-ai-btn" @click="aiContinueWriting()" :disabled="!$store.ai.hasApiKey()">
                            <i data-lucide="wand-2" width="16" height="16"></i>
                            <span>Continuar escribiendo</span>
                        </button>
                        <button type="button" class="editor-ai-btn" @click="aiSuggestImprovements()" :disabled="!$store.ai.hasApiKey()">
                            <i data-lucide="lightbulb" width="16" height="16"></i>
                            <span>Sugerir mejoras</span>
                        </button>
                        <button type="button" class="editor-ai-btn" @click="aiGenerateContent()" :disabled="!$store.ai.hasApiKey()">
                            <i data-lucide="sparkles" width="16" height="16"></i>
                            <span>Generar contenido</span>
                        </button>
                        <button type="button" class="editor-ai-btn" @click="aiSummarizeChapter()" :disabled="!$store.ai.hasApiKey()">
                            <i data-lucide="book-open" width="16" height="16"></i>
                            <span>Resumir capítulo</span>
                        </button>
                    </div>
                    <template x-if="!$store.ai.hasApiKey()">
                        <p style="font-size: 12px; color: var(--text-tertiary); margin-top: 12px; text-align: center;">
                            <i data-lucide="alert-circle" width="14" height="14" style="display: inline;"></i>
                            <span x-text="$store.i18n.t('ai.settings.noApiKey')"></span>
                        </p>
                    </template>

                    <!-- Historial de Conversaciones IA -->
                    <template x-if="$store.project.getChapterConversations($store.ui.currentEditingChapterId).length > 0">
                        <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border);">
                            <h4 style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px; font-weight: 600; text-transform: uppercase;">
                                Historial de Conversaciones
                            </h4>
                            <div style="display: flex; flex-direction: column; gap: 6px;">
                                <template x-for="conv in $store.project.getChapterConversations($store.ui.currentEditingChapterId).slice(0, 5)" :key="conv.id">
                                    <div @click="openConversation(conv.id)" class="ai-conversation-item" style="padding: 8px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; transition: all 0.2s;">
                                        <div style="display: flex; align-items: start; gap: 6px;">
                                            <!-- Icono según el modo -->
                                            <i :data-lucide="conv.mode === 'continue' ? 'wand-2' : conv.mode === 'improve' ? 'lightbulb' : conv.mode === 'analyze' ? 'book-open' : 'sparkles'" width="14" height="14" style="color: var(--accent); flex-shrink: 0; margin-top: 2px;"></i>

                                            <div style="flex: 1; min-width: 0;">
                                                <!-- Nombre de la conversación -->
                                                <div style="font-size: 12px; font-weight: 500; color: var(--text-primary); margin-bottom: 2px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                                    <span x-text="conv.name || 'Generando nombre...'"></span>
                                                    <!-- Indicador de usado -->
                                                    <template x-if="conv.metadata.wasUsed">
                                                        <i data-lucide="check-circle" width="12" height="12" style="color: var(--success); display: inline; margin-left: 4px;"></i>
                                                    </template>
                                                </div>
                                                <!-- Timestamp -->
                                                <div style="font-size: 10px; color: var(--text-tertiary);" x-text="new Date(conv.createdAt).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' })"></div>
                                            </div>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </template>
                </div>
            </aside>
        </div>
    </template>

    <!-- Empty state si no hay capítulo seleccionado -->
    <template x-if="!currentChapter">
        <div class="empty-state">
            <i data-lucide="book-open" width="64" height="64"></i>
            <p>No hay capítulo seleccionado</p>
            <button class="btn-primary" @click="$store.ui.setView('chapters')" style="margin-top: 16px;">
                <span x-text="$store.i18n.t('sidebar.chapters')"></span>
            </button>
        </div>
    </template>
</div>